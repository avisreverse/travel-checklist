<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>India Travel Checklist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f0f2f5;
            margin: 0;
            padding: 0;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 20px;
            text-align: center;
        }

        .header h1 { font-size: 28px; font-weight: 800; margin: 0; }
        .header p { font-size: 14px; opacity: 0.9; margin: 5px 0 0 0; }

        .container { max-width: 1200px; margin: 0 auto; background: white; min-height: 100vh; }

        .nav-container {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 15px 20px;
            border-bottom: 2px solid #e5e7eb;
            -webkit-overflow-scrolling: touch;
        }

        .nav-container::-webkit-scrollbar { height: 4px; }
        .nav-container::-webkit-scrollbar-thumb { background: #667eea; border-radius: 2px; }

        .nav-btn {
            padding: 10px 16px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            white-space: nowrap;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .nav-btn:hover { border-color: #667eea; background: #f0f4ff; }
        .nav-btn.active { background: #667eea; color: white; border-color: #667eea; }

        .content { padding: 20px; }

        .tab-view { display: none; }
        .tab-view.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* DASHBOARD SECTION */
        .dashboard-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 12px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            border: 2px solid #e5e7eb;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        .stat-card.completed { border-left-color: #10b981; }
        .stat-card.in-progress { border-left-color: #f59e0b; }
        .stat-card.waiting { border-left-color: #8b5cf6; }
        .stat-card.not-started { border-left-color: #ef4444; }
        .stat-card.overdue { border-left-color: #dc2626; }
        .stat-card.siva { border-left-color: #3b82f6; }
        .stat-card.priya { border-left-color: #ec4899; }
        .stat-card.both { border-left-color: #8b5cf6; }
        .stat-card.not-assigned { border-left-color: #999; }

        .stat-number { font-size: 32px; font-weight: 800; color: #667eea; margin: 5px 0; }
        .stat-label { font-size: 12px; color: #666; font-weight: 600; }

        /* CATEGORY SECTION */
        .category-section {
            margin-bottom: 30px;
        }

        .category-header {
            font-size: 16px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 15px;
            padding: 12px 15px;
            background: #f0f4ff;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }

        .add-task-form {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e5e7eb;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 10px;
            align-items: end;
        }

        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-bottom: 5px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
        }

        .btn-add {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
        }

        .btn-add:hover { background: #764ba2; }

        /* TASK CARD */
        .task-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .task-item.completed {
            opacity: 0.6;
            background: #f0fdf4;
            border-left-color: #10b981;
        }

        .task-item.overdue {
            background: #fef2f2;
            border-left-color: #dc2626;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
            flex-wrap: wrap;
        }

        .task-title {
            font-weight: 600;
            color: #1a1a1a;
            font-size: 14px;
        }

        .task-item.completed .task-title {
            text-decoration: line-through;
            color: #999;
        }

        .task-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            color: white;
        }

        .task-badge.siva { background: #3b82f6; }
        .task-badge.priya { background: #ec4899; }
        .task-badge.both { background: #8b5cf6; }
        .task-badge.not-assigned { background: #999; }

        .task-controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto auto;
            gap: 8px;
            align-items: center;
            margin-top: 10px;
        }

        .task-controls select,
        .task-controls input {
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            font-family: inherit;
        }

        .btn-edit {
            padding: 6px 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            opacity: 0.8;
            transition: all 0.2s;
        }

        .btn-edit:hover {
            opacity: 1;
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* TASK LIST MODAL */
        .modal-content.large {
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content.large .modal-body {
            max-height: calc(80vh - 150px);
            overflow-y: auto;
        }

        .task-list-item {
            background: #f9fafb;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .task-list-item.completed {
            background: #f0fdf4;
            border-left-color: #10b981;
            opacity: 0.7;
        }

        .task-list-item.in-progress {
            background: #fffbeb;
            border-left-color: #f59e0b;
        }

        .task-list-item.waiting {
            background: #f3f4f6;
            border-left-color: #8b5cf6;
        }

        .task-list-item.not-started {
            background: #fef2f2;
            border-left-color: #ef4444;
        }

        .task-list-item.overdue {
            background: #fee2e2;
            border-left-color: #dc2626;
        }

        .task-list-title {
            font-weight: 600;
            color: #1a1a1a;
            font-size: 14px;
            margin-bottom: 6px;
        }

        .task-list-meta {
            font-size: 12px;
            color: #666;
            display: flex;
            gap: 15px;
        }

        .modal-header {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #667eea;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-body label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
        }

        .modal-body textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            min-height: 100px;
            box-sizing: border-box;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn-modal {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
        }

        .btn-save {
            background: #667eea;
            color: white;
        }

        .btn-save:hover {
            background: #764ba2;
        }

        .btn-cancel {
            background: #e5e7eb;
            color: #666;
        }

        .btn-cancel:hover {
            background: #d1d5db;
        }

        .task-meta {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
        }

        .task-meta.overdue { color: #dc2626; font-weight: 600; }

        /* MOBILE */
        @media (max-width: 768px) {
            .header h1 { font-size: 22px; }
            .stats-row { grid-template-columns: repeat(2, 1fr); }
            .form-grid { grid-template-columns: 1fr; }
            .task-controls { grid-template-columns: 1fr 1fr; }
            .stat-number { font-size: 24px; }
            .nav-container { flex-wrap: wrap; justify-content: center; }
            .nav-btn { font-size: 11px; padding: 8px 12px; flex: 1 1 auto; min-width: auto; }
            .category-header { font-size: 14px; word-wrap: break-word; white-space: normal; }
            .add-task-form { padding: 12px; }
            .btn-add { width: 100%; }
            .task-controls { grid-template-columns: 1fr; }
            .btn-edit, .btn-delete { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>‚úàÔ∏è India Travel Checklist</h1>
        <p>Family Trip Nov 22 - Dec 15 | Cloud Synced</p>
    </div>

    <div class="container">
        <!-- NAVIGATION -->
        <div class="nav-container">
            <button class="nav-btn active" onclick="switchView('dashboard')">üìä Dashboard</button>
            <button class="nav-btn" onclick="switchView('critical')">üî¥ Critical</button>
            <button class="nav-btn" onclick="switchView('documents')">üìÑ Documents</button>
            <button class="nav-btn" onclick="switchView('financial')">üí≥ Financial</button>
            <button class="nav-btn" onclick="switchView('employer')">üëî Employer</button>
            <button class="nav-btn" onclick="switchView('school')">üìö School</button>
            <button class="nav-btn" onclick="switchView('home')">üè† Home</button>
            <button class="nav-btn" onclick="switchView('medical')">‚öïÔ∏è Medical</button>
            <button class="nav-btn" onclick="switchView('india')">üáÆüá≥ India</button>
            <button class="nav-btn" onclick="switchView('packing')">üéí Packing</button>
            <button class="nav-btn" onclick="switchView('final')">‚úÖ Final</button>
        </div>

        <div class="content">
            <div style="text-align: right; padding: 10px 20px; border-bottom: 1px solid #e5e7eb;">
                <button onclick="clearFirebase()" style="padding: 6px 12px; background: #dc2626; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">üîÑ Reset Firebase</button>
            </div>

            <!-- EDIT MODAL -->
            <div id="editModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">‚úèÔ∏è Edit Task</div>
                    <div class="modal-body">
                        <label>Task Description</label>
                        <textarea id="editTaskTitle" placeholder="Enter task description..."></textarea>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-modal btn-cancel" onclick="closeEditModal()">Cancel</button>
                        <button class="btn-modal btn-save" onclick="saveTaskEdit()">Save Changes</button>
                    </div>
                </div>
            </div>

            <!-- TASK LIST MODAL -->
            <div id="taskListModal" class="modal">
                <div class="modal-content large">
                    <div class="modal-header" id="taskListTitle">üìã Tasks</div>
                    <div class="modal-body" id="taskListContent">
                        <!-- Tasks will be inserted here -->
                    </div>
                    <div class="modal-footer">
                        <button class="btn-modal btn-cancel" onclick="closeTaskListModal()">Close</button>
                    </div>
                </div>
            </div>
            <!-- DASHBOARD -->
            <div id="dashboard" class="tab-view active">
                <!-- Task Status Dashboard -->
                <div class="dashboard-section">
                    <div class="section-title">üìä Task Status Overview</div>
                    <div class="stats-row">
                        <div class="stat-card completed">
                            <div class="stat-number" id="stat-completed">0</div>
                            <div class="stat-label">‚úÖ Completed</div>
                        </div>
                        <div class="stat-card in-progress">
                            <div class="stat-number" id="stat-in-progress">0</div>
                            <div class="stat-label">üîÑ In Progress</div>
                        </div>
                        <div class="stat-card waiting">
                            <div class="stat-number" id="stat-waiting">0</div>
                            <div class="stat-label">‚è≥ Waiting</div>
                        </div>
                        <div class="stat-card not-started">
                            <div class="stat-number" id="stat-not-started">0</div>
                            <div class="stat-label">üìã Not Started</div>
                        </div>
                        <div class="stat-card overdue">
                            <div class="stat-number" id="stat-overdue">0</div>
                            <div class="stat-label">‚ö†Ô∏è Overdue</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="stat-total">0</div>
                            <div class="stat-label">üìù Total</div>
                        </div>
                    </div>
                </div>

                <!-- Assignee Dashboard -->
                <div class="dashboard-section">
                    <div class="section-title">üë• Tasks by Assignee</div>
                    <div class="stats-row">
                        <div class="stat-card siva">
                            <div class="stat-number" id="stat-siva">0</div>
                            <div class="stat-label">üë® Siva</div>
                        </div>
                        <div class="stat-card priya">
                            <div class="stat-number" id="stat-priya">0</div>
                            <div class="stat-label">üë© Priya</div>
                        </div>
                        <div class="stat-card both">
                            <div class="stat-number" id="stat-both">0</div>
                            <div class="stat-label">üë• Both</div>
                        </div>
                        <div class="stat-card not-assigned">
                            <div class="stat-number" id="stat-not-assigned">0</div>
                            <div class="stat-label">‚ùì Not Assigned</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CATEGORIES -->
            <div id="critical" class="tab-view"></div>
            <div id="documents" class="tab-view"></div>
            <div id="financial" class="tab-view"></div>
            <div id="employer" class="tab-view"></div>
            <div id="school" class="tab-view"></div>
            <div id="home" class="tab-view"></div>
            <div id="medical" class="tab-view"></div>
            <div id="india" class="tab-view"></div>
            <div id="packing" class="tab-view"></div>
            <div id="final" class="tab-view"></div>
        </div>
    </div>

    <script>
        let tasks = [];
        let nextId = 1;
        let databaseURL = 'https://travel-checklist-a6682-default-rtdb.firebaseio.com';

        const firebaseConfig = {
            databaseURL: 'https://travel-checklist-a6682-default-rtdb.firebaseio.com'
        };

        const categoryMap = {
            'critical': 'üî¥ CRITICAL - DO THIS FIRST',
            'documents': 'üìÑ DOCUMENTS TO PREPARE',
            'financial': 'üí≥ FINANCIAL & BANKING',
            'employer': 'üëî EMPLOYER & WORK',
            'school': 'üìö SCHOOL & FAMILY',
            'home': 'üè† HOME PREPARATION',
            'medical': '‚öïÔ∏è MEDICAL PREPARATIONS',
            'india': 'üáÆüá≥ INDIA PREPARATIONS',
            'packing': 'üéí PACKING CHECKLIST',
            'final': '‚úÖ FINAL PREPARATIONS'
        };

        function isOverdue(dueDate) {
            if (!dueDate) return false;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const due = new Date(dueDate);
            return due < today;
        }

        function loadDefaultTasks() {
            tasks = [
                { id: 1, category: 'üî¥ CRITICAL - DO THIS FIRST', title: 'Verify I-94 validity for all family members', assigned: '', status: 'not-started', dueDate: '' },
                { id: 2, category: 'üî¥ CRITICAL - DO THIS FIRST', title: 'Check USCIS SEVIS database and CBP I-94 records', assigned: '', status: 'not-started', dueDate: '' },
                { id: 3, category: 'üî¥ CRITICAL - DO THIS FIRST', title: 'Apply for I-131 (Advance Parole) if I-94 expired', assigned: '', status: 'not-started', dueDate: '' },
                { id: 4, category: 'üî¥ CRITICAL - DO THIS FIRST', title: 'Confirm H1B is valid and hasn\'t expired', assigned: '', status: 'not-started', dueDate: '' },
                { id: 5, category: 'üî¥ CRITICAL - DO THIS FIRST', title: 'Confirm wife\'s and son\'s H4 validity', assigned: '', status: 'not-started', dueDate: '' },
                { id: 6, category: 'üî¥ CRITICAL - DO THIS FIRST', title: 'Verify wife\'s EAD Card is valid', assigned: '', status: 'not-started', dueDate: '' },
                { id: 7, category: 'üî¥ CRITICAL - DO THIS FIRST', title: 'Verify all passports are valid (6+ months)', assigned: '', status: 'not-started', dueDate: '' },
                { id: 8, category: 'üî¥ CRITICAL - DO THIS FIRST', title: 'Get India visa for you, wife, and son', assigned: '', status: 'not-started', dueDate: '' },
                { id: 9, category: 'üî¥ CRITICAL - DO THIS FIRST', title: 'Confirm daughter has US passport', assigned: '', status: 'not-started', dueDate: '' },
                { id: 10, category: 'üî¥ CRITICAL - DO THIS FIRST', title: 'Clarify H1B extension or initial visa interview', assigned: '', status: 'not-started', dueDate: '' },
                { id: 11, category: 'üî¥ CRITICAL - DO THIS FIRST', title: 'Gather employment documents (offer letter, pay stubs)', assigned: '', status: 'not-started', dueDate: '' },
                { id: 12, category: 'üî¥ CRITICAL - DO THIS FIRST', title: 'Collect I-797 approval notices', assigned: '', status: 'not-started', dueDate: '' },
                { id: 13, category: 'üî¥ CRITICAL - DO THIS FIRST', title: 'Confirm visa interview date, time, location', assigned: '', status: 'not-started', dueDate: '' },
                { id: 14, category: 'üî¥ CRITICAL - DO THIS FIRST', title: 'Prepare interview answers and documents', assigned: '', status: 'not-started', dueDate: '' },
                { id: 15, category: 'üìÑ DOCUMENTS TO PREPARE', title: 'Collect all passports (valid 6+ months)', assigned: '', status: 'not-started', dueDate: '' },
                { id: 16, category: 'üìÑ DOCUMENTS TO PREPARE', title: 'Copy all stamped visa pages', assigned: '', status: 'not-started', dueDate: '' },
                { id: 17, category: 'üìÑ DOCUMENTS TO PREPARE', title: 'Print I-94 records from CBP website', assigned: '', status: 'not-started', dueDate: '' },
                { id: 18, category: 'üìÑ DOCUMENTS TO PREPARE', title: 'Collect I-797 forms (H1B and H4)', assigned: '', status: 'not-started', dueDate: '' },
                { id: 19, category: 'üìÑ DOCUMENTS TO PREPARE', title: 'Carry wife\'s original EAD card', assigned: '', status: 'not-started', dueDate: '' },
                { id: 20, category: 'üìÑ DOCUMENTS TO PREPARE', title: 'Collect birth certificates for all', assigned: '', status: 'not-started', dueDate: '' },
                { id: 21, category: 'üìÑ DOCUMENTS TO PREPARE', title: 'Get certified copy of marriage certificate', assigned: '', status: 'not-started', dueDate: '' },
                { id: 22, category: 'üìÑ DOCUMENTS TO PREPARE', title: 'Print flight tickets (6 copies)', assigned: '', status: 'not-started', dueDate: '' },
                { id: 23, category: 'üìÑ DOCUMENTS TO PREPARE', title: 'Print hotel reservations', assigned: '', status: 'not-started', dueDate: '' },
                { id: 24, category: 'üìÑ DOCUMENTS TO PREPARE', title: 'Print travel insurance policy', assigned: '', status: 'not-started', dueDate: '' },
                { id: 25, category: 'üìÑ DOCUMENTS TO PREPARE', title: 'Collect medical records and vaccination records', assigned: '', status: 'not-started', dueDate: '' },
                { id: 26, category: 'üí≥ FINANCIAL & BANKING', title: 'Inform banks about travel dates', assigned: '', status: 'not-started', dueDate: '' },
                { id: 27, category: 'üí≥ FINANCIAL & BANKING', title: 'Get printed bank statements (3-6 months)', assigned: '', status: 'not-started', dueDate: '' },
                { id: 28, category: 'üí≥ FINANCIAL & BANKING', title: 'Carry 2-3 credit cards (different companies)', assigned: '', status: 'not-started', dueDate: '' },
                { id: 29, category: 'üí≥ FINANCIAL & BANKING', title: 'Exchange USD to INR', assigned: '', status: 'not-started', dueDate: '' },
                { id: 30, category: 'üí≥ FINANCIAL & BANKING', title: 'Notify wife\'s employer about EAD travel', assigned: '', status: 'not-started', dueDate: '' },
                { id: 31, category: 'üëî EMPLOYER & WORK', title: 'Notify your employer of travel dates', assigned: '', status: 'not-started', dueDate: '' },
                { id: 32, category: 'üëî EMPLOYER & WORK', title: 'Confirm return ticket to resume work immediately', assigned: '', status: 'not-started', dueDate: '' },
                { id: 33, category: 'üëî EMPLOYER & WORK', title: 'Get employer letter confirming employment', assigned: '', status: 'not-started', dueDate: '' },
                { id: 34, category: 'üëî EMPLOYER & WORK', title: 'Wife: Notify your employer about travel', assigned: '', status: 'not-started', dueDate: '' },
                { id: 35, category: 'üëî EMPLOYER & WORK', title: 'Wife: Get employment letter from company', assigned: '', status: 'not-started', dueDate: '' },
                { id: 36, category: 'üìö SCHOOL & FAMILY', title: 'Get official letter from school confirming grade', assigned: '', status: 'not-started', dueDate: '' },
                { id: 37, category: 'üìö SCHOOL & FAMILY', title: 'Collect homework/assignments for missed dates', assigned: '', status: 'not-started', dueDate: '' },
                { id: 38, category: 'üìö SCHOOL & FAMILY', title: 'Contact school about re-entry procedures', assigned: '', status: 'not-started', dueDate: '' },
                { id: 39, category: 'üìö SCHOOL & FAMILY', title: 'Get required immunization records', assigned: '', status: 'not-started', dueDate: '' },
                { id: 40, category: 'üè† HOME PREPARATION', title: 'Arrange mail hold with USPS', assigned: '', status: 'not-started', dueDate: '' },
                { id: 41, category: 'üè† HOME PREPARATION', title: 'Lock all windows and doors', assigned: '', status: 'not-started', dueDate: '' },
                { id: 42, category: 'üè† HOME PREPARATION', title: 'Set thermostat appropriately', assigned: '', status: 'not-started', dueDate: '' },
                { id: 43, category: 'üè† HOME PREPARATION', title: 'Ask neighbor to check on home', assigned: '', status: 'not-started', dueDate: '' },
                { id: 44, category: 'üè† HOME PREPARATION', title: 'Take photos of valuable items for insurance', assigned: '', status: 'not-started', dueDate: '' },
                { id: 45, category: '‚öïÔ∏è MEDICAL PREPARATIONS', title: 'Refill all prescriptions', assigned: '', status: 'not-started', dueDate: '' },
                { id: 46, category: '‚öïÔ∏è MEDICAL PREPARATIONS', title: 'Visit dentist for checkup', assigned: '', status: 'not-started', dueDate: '' },
                { id: 47, category: '‚öïÔ∏è MEDICAL PREPARATIONS', title: 'Visit doctor for checkup', assigned: '', status: 'not-started', dueDate: '' },
                { id: 48, category: '‚öïÔ∏è MEDICAL PREPARATIONS', title: 'Get doctor\'s letter for medications', assigned: '', status: 'not-started', dueDate: '' },
                { id: 49, category: '‚öïÔ∏è MEDICAL PREPARATIONS', title: 'Research hospitals near India destination', assigned: '', status: 'not-started', dueDate: '' },
                { id: 50, category: 'üáÆüá≥ INDIA PREPARATIONS', title: 'Book accommodations (hotel/family home)', assigned: '', status: 'not-started', dueDate: '' },
                { id: 51, category: 'üáÆüá≥ INDIA PREPARATIONS', title: 'Arrange transportation from airport', assigned: '', status: 'not-started', dueDate: '' },
                { id: 52, category: 'üáÆüá≥ INDIA PREPARATIONS', title: 'Confirm visa interview appointment details', assigned: '', status: 'not-started', dueDate: '' },
                { id: 53, category: 'üáÆüá≥ INDIA PREPARATIONS', title: 'Check weather forecast for India', assigned: '', status: 'not-started', dueDate: '' },
                { id: 54, category: 'üáÆüá≥ INDIA PREPARATIONS', title: 'Get Indian phone SIM or roaming plan', assigned: '', status: 'not-started', dueDate: '' },
                { id: 55, category: 'üáÆüá≥ INDIA PREPARATIONS', title: 'Notify family in India of arrival details', assigned: '', status: 'not-started', dueDate: '' },
                { id: 56, category: 'üáÆüá≥ INDIA PREPARATIONS', title: 'Purchase travel insurance', assigned: '', status: 'not-started', dueDate: '' },
                { id: 57, category: 'üáÆüá≥ INDIA PREPARATIONS', title: 'Print insurance policy and save digital copy', assigned: '', status: 'not-started', dueDate: '' },
                { id: 58, category: 'üáÆüá≥ INDIA PREPARATIONS', title: 'Convert USD to INR before departure', assigned: '', status: 'not-started', dueDate: '' },
                { id: 59, category: 'üáÆüá≥ INDIA PREPARATIONS', title: 'Research current exchange rates', assigned: '', status: 'not-started', dueDate: '' },
                { id: 60, category: 'üéí PACKING CHECKLIST', title: 'Pack copies of all important documents', assigned: '', status: 'not-started', dueDate: '' },
                { id: 61, category: 'üéí PACKING CHECKLIST', title: 'Pack passports (originals)', assigned: '', status: 'not-started', dueDate: '' },
                { id: 62, category: 'üéí PACKING CHECKLIST', title: 'Pack I-94 cards (originals)', assigned: '', status: 'not-started', dueDate: '' },
                { id: 63, category: 'üéí PACKING CHECKLIST', title: 'Pack medications (full supply)', assigned: '', status: 'not-started', dueDate: '' },
                { id: 64, category: 'üéí PACKING CHECKLIST', title: 'Pack phone chargers and power bank', assigned: '', status: 'not-started', dueDate: '' },
                { id: 65, category: 'üéí PACKING CHECKLIST', title: 'Pack credit cards and cash ($500)', assigned: '', status: 'not-started', dueDate: '' },
                { id: 66, category: 'üéí PACKING CHECKLIST', title: 'Pack winter/summer clothes for India', assigned: '', status: 'not-started', dueDate: '' },
                { id: 67, category: 'üéí PACKING CHECKLIST', title: 'Pack toiletries and first aid kit', assigned: '', status: 'not-started', dueDate: '' },
                { id: 68, category: 'üéí PACKING CHECKLIST', title: 'Pack formal wear for visa interview', assigned: '', status: 'not-started', dueDate: '' },
                { id: 69, category: 'üéí PACKING CHECKLIST', title: 'Pack son\'s study materials', assigned: '', status: 'not-started', dueDate: '' },
                { id: 70, category: 'üéí PACKING CHECKLIST', title: 'Pack universal adapter for India', assigned: '', status: 'not-started', dueDate: '' },
                { id: 71, category: '‚úÖ FINAL PREPARATIONS', title: 'Reconfirm flight on Etihad website', assigned: '', status: 'not-started', dueDate: '' },
                { id: 72, category: '‚úÖ FINAL PREPARATIONS', title: 'Register with US Embassy using STEP program', assigned: '', status: 'not-started', dueDate: '' },
                { id: 73, category: '‚úÖ FINAL PREPARATIONS', title: 'Arrive airport 3 hours before departure', assigned: '', status: 'not-started', dueDate: '' },
                { id: 74, category: '‚úÖ FINAL PREPARATIONS', title: 'Confirm Etihad return flight (Dec 15)', assigned: '', status: 'not-started', dueDate: '' },
                { id: 75, category: '‚úÖ FINAL PREPARATIONS', title: 'Reconfirm return flight 24 hours before departure', assigned: '', status: 'not-started', dueDate: '' }
            ];
            nextId = 76;
        }

        function saveTasks() {
            if (!databaseURL) {
                console.log('Firebase URL not ready');
                return;
            }
            
            // Validate tasks have required fields
            const validTasks = tasks.filter(t => 
                t && t.id && t.category && t.title && t.hasOwnProperty('assigned') && t.hasOwnProperty('status')
            );
            
            if (validTasks.length === 0) {
                console.log('No valid tasks to save');
                return;
            }
            
            const tasksObj = {};
            validTasks.forEach((task, index) => { 
                tasksObj[index] = task; 
            });
            
            console.log('Saving', validTasks.length, 'tasks to Firebase');
            
            fetch(databaseURL + '/tasks.json', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(tasksObj)
            })
            .then(r => {
                if (r.ok) console.log('‚úÖ Tasks saved to Firebase');
                else console.log('Save HTTP error:', r.status);
            })
            .catch(e => console.log('Save error:', e.message));
        }

        function displayDashboard() {
            const stats = {
                completed: tasks.filter(t => t.status === 'completed').length,
                'in-progress': tasks.filter(t => t.status === 'in-progress').length,
                waiting: tasks.filter(t => t.status === 'waiting').length,
                'not-started': tasks.filter(t => t.status === 'not-started').length,
                overdue: tasks.filter(t => isOverdue(t.dueDate) && t.status !== 'completed').length,
                siva: tasks.filter(t => t.assigned === 'Siva').length,
                priya: tasks.filter(t => t.assigned === 'Priya').length,
                both: tasks.filter(t => t.assigned === 'Both').length,
                'not-assigned': tasks.filter(t => !t.assigned || t.assigned === '').length
            };

            document.getElementById('stat-completed').textContent = stats.completed;
            document.getElementById('stat-completed').parentElement.onclick = () => showTasksByStatus('completed', '‚úÖ Completed Tasks');
            
            document.getElementById('stat-in-progress').textContent = stats['in-progress'];
            document.getElementById('stat-in-progress').parentElement.onclick = () => showTasksByStatus('in-progress', 'üîÑ In Progress Tasks');
            
            document.getElementById('stat-waiting').textContent = stats.waiting;
            document.getElementById('stat-waiting').parentElement.onclick = () => showTasksByStatus('waiting', '‚è≥ Waiting Tasks');
            
            document.getElementById('stat-not-started').textContent = stats['not-started'];
            document.getElementById('stat-not-started').parentElement.onclick = () => showTasksByStatus('not-started', 'üìã Not Started Tasks');
            
            document.getElementById('stat-overdue').textContent = stats.overdue;
            document.getElementById('stat-overdue').parentElement.onclick = () => showTasksByStatus('overdue', '‚ö†Ô∏è Overdue Tasks');
            
            document.getElementById('stat-total').textContent = tasks.length;
            document.getElementById('stat-total').parentElement.onclick = () => showTasksByStatus('all', 'üìù All Tasks');
            
            document.getElementById('stat-siva').textContent = stats.siva;
            document.getElementById('stat-siva').parentElement.onclick = () => showTasksByAssignee('Siva', 'üë® Siva\'s Tasks');
            
            document.getElementById('stat-priya').textContent = stats.priya;
            document.getElementById('stat-priya').parentElement.onclick = () => showTasksByAssignee('Priya', 'üë© Priya\'s Tasks');
            
            document.getElementById('stat-both').textContent = stats.both;
            document.getElementById('stat-both').parentElement.onclick = () => showTasksByAssignee('Both', 'üë• Shared Tasks');
            
            document.getElementById('stat-not-assigned').textContent = stats['not-assigned'];
            document.getElementById('stat-not-assigned').parentElement.onclick = () => showTasksByAssignee('', '‚ùì Not Assigned Tasks');
        }

        function displayTasks() {
            console.log('displayTasks called. Total tasks:', tasks.length);
            
            Object.keys(categoryMap).forEach(tab => {
                const categoryName = categoryMap[tab];
                const container = document.getElementById(tab);

                if (!container) {
                    console.error('Container not found for tab:', tab);
                    return;
                }

                const categoryTasks = tasks.filter(t => t.category === categoryName);
                console.log(`Category ${categoryName}: ${categoryTasks.length} tasks`);

                // Save input value if exists
                const inputId = 'newTask_' + tab;
                const existingInput = document.getElementById(inputId);
                const savedInputValue = existingInput ? existingInput.value : '';

                // Build complete HTML
                let html = `
                    <div class="add-task-form">
                        <div style="font-weight: 600; margin-bottom: 10px; color: #666;">‚ûï Add New Task</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Title</label>
                                <input type="text" id="newTask_${tab}" placeholder="Task name..." value="${savedInputValue}" />
                            </div>
                            <div class="form-group">
                                <label>Due Date</label>
                                <input type="date" id="newDate_${tab}" />
                            </div>
                            <button class="btn-add" onclick="addTask('${tab}', '${categoryName}')">Add</button>
                        </div>
                    </div>
                    <div class="category-header">${categoryName}</div>
                `;

                if (categoryTasks.length === 0) {
                    html += '<div style="text-align: center; padding: 30px; color: #999;">No tasks in this category</div>';
                } else {
                    categoryTasks.forEach(task => {
                        const isOverdueTask = isOverdue(task.dueDate) && task.status !== 'completed';
                        const assignedBadge = task.assigned 
                            ? `<span class="task-badge ${task.assigned.toLowerCase()}">${task.assigned === 'Siva' ? 'üë®' : task.assigned === 'Priya' ? 'üë©' : 'üë•'} ${task.assigned}</span>` 
                            : '<span class="task-badge not-assigned">‚ùì Not Assigned</span>';

                        html += `
                            <div class="task-item ${task.status === 'completed' ? 'completed' : ''} ${isOverdueTask ? 'overdue' : ''}">
                                <div class="task-header">
                                    <div class="task-title">${task.title}</div>
                                    ${assignedBadge}
                                </div>
                                ${task.dueDate ? `<div class="task-meta ${isOverdueTask ? 'overdue' : ''}">üìÖ ${new Date(task.dueDate).toLocaleDateString()} ${isOverdueTask ? '‚ö†Ô∏è OVERDUE' : ''}</div>` : ''}
                                <div class="task-controls">
                                    <select onchange="updateStatus(${task.id}, this.value)">
                                        <option value="not-started" ${task.status === 'not-started' ? 'selected' : ''}>Not Started</option>
                                        <option value="in-progress" ${task.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                                        <option value="waiting" ${task.status === 'waiting' ? 'selected' : ''}>Waiting</option>
                                        <option value="completed" ${task.status === 'completed' ? 'selected' : ''}>Completed</option>
                                    </select>
                                    <input type="date" value="${task.dueDate || ''}" onchange="updateDate(${task.id}, this.value)">
                                    <select onchange="updateAssigned(${task.id}, this.value)">
                                        <option value="">‚ùì Not Assigned</option>
                                        <option value="Siva" ${task.assigned === 'Siva' ? 'selected' : ''}>üë® Siva</option>
                                        <option value="Priya" ${task.assigned === 'Priya' ? 'selected' : ''}>üë© Priya</option>
                                        <option value="Both" ${task.assigned === 'Both' ? 'selected' : ''}>üë• Both</option>
                                    </select>
                                    <button class="btn-edit" onclick="openEditModal(${task.id}, '${task.title.replace(/'/g, "\\'")}')">‚úèÔ∏è Edit</button>
                                    <button class="btn-delete" onclick="deleteTask(${task.id})" title="Delete">üóëÔ∏è</button>
                                </div>
                            </div>
                        `;
                    });
                }

                container.innerHTML = html;
            });

            displayDashboard();
        }

        function addTask(tab, categoryName) {
            const title = document.getElementById(`newTask_${tab}`).value.trim();
            const dueDate = document.getElementById(`newDate_${tab}`).value;

            if (!title) {
                alert('Please enter a task title');
                return;
            }

            tasks.push({
                id: nextId++,
                category: categoryName,
                title,
                assigned: '',
                status: 'not-started',
                dueDate
            });

            saveTasks();
            displayTasks();
        }

        function updateStatus(id, status) {
            const task = tasks.find(t => t.id === id);
            if (task) {
                task.status = status;
                saveTasks();
                displayTasks();
            }
        }

        function updateDate(id, date) {
            const task = tasks.find(t => t.id === id);
            if (task) {
                task.dueDate = date;
                saveTasks();
                displayTasks();
            }
        }

        function updateAssigned(id, assigned) {
            const task = tasks.find(t => t.id === id);
            if (task) {
                task.assigned = assigned;
                saveTasks();
                displayTasks();
            }
        }

        function deleteTask(id) {
            if (confirm('Delete this task?')) {
                tasks = tasks.filter(t => t.id !== id);
                saveTasks();
                displayTasks();
            }
        }

        let editingTaskId = null;

        function openEditModal(taskId, taskTitle) {
            editingTaskId = taskId;
            document.getElementById('editTaskTitle').value = taskTitle;
            document.getElementById('editModal').classList.add('active');
            document.getElementById('editTaskTitle').focus();
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            editingTaskId = null;
        }

        function saveTaskEdit() {
            if (!editingTaskId) return;

            const newTitle = document.getElementById('editTaskTitle').value.trim();
            if (!newTitle) {
                alert('Please enter a task description');
                return;
            }

            const task = tasks.find(t => t.id === editingTaskId);
            if (task) {
                task.title = newTitle;
                saveTasks();
                displayTasks();
                closeEditModal();
                console.log('‚úÖ Task updated:', newTitle);
            }
        }

        function clearFirebase() {
            if (confirm('üîÑ This will DELETE all Firebase data and rebuild with fresh default tasks. Continue?')) {
                fetch(databaseURL + '/tasks.json', {
                    method: 'DELETE'
                }).then(() => {
                    console.log('‚úÖ Firebase cleared');
                    loadDefaultTasks();
                    saveTasks();  // Save the fresh defaults to Firebase
                    displayTasks();
                    alert('‚úÖ Firebase cleared and rebuilt with fresh data!');
                    location.reload();  // Reload to refresh UI
                }).catch(e => {
                    console.log('Error clearing Firebase:', e);
                    alert('Could not clear Firebase. Try manually via Firebase Console.');
                });
            }
        }

        function showTasksByStatus(status, title) {
            let filteredTasks = [];
            
            if (status === 'overdue') {
                filteredTasks = tasks.filter(t => isOverdue(t.dueDate) && t.status !== 'completed');
            } else if (status === 'all') {
                filteredTasks = tasks;
            } else {
                filteredTasks = tasks.filter(t => t.status === status);
            }
            
            displayTaskListModal(filteredTasks, title);
        }

        function showTasksByAssignee(assignee, title) {
            let filteredTasks = [];
            
            if (assignee === '') {
                filteredTasks = tasks.filter(t => !t.assigned || t.assigned === '');
            } else {
                filteredTasks = tasks.filter(t => t.assigned === assignee);
            }
            
            displayTaskListModal(filteredTasks, title);
        }

        function displayTaskListModal(filteredTasks, title) {
            const titleEl = document.getElementById('taskListTitle');
            const contentEl = document.getElementById('taskListContent');
            
            titleEl.textContent = title + ' (' + filteredTasks.length + ')';
            
            if (filteredTasks.length === 0) {
                contentEl.innerHTML = '<div style="text-align: center; padding: 30px; color: #999;">No tasks found</div>';
            } else {
                let html = '';
                filteredTasks.forEach(task => {
                    const isOverdueTask = isOverdue(task.dueDate) && task.status !== 'completed';
                    const statusClass = isOverdueTask ? 'overdue' : task.status;
                    const assignedBadge = task.assigned ? task.assigned : 'Not Assigned';
                    
                    const statusLabel = task.status === 'not-started' ? 'Not Started' 
                                      : task.status === 'in-progress' ? 'In Progress'
                                      : task.status === 'waiting' ? 'Waiting'
                                      : 'Completed';
                    
                    html += `
                        <div class="task-list-item ${statusClass}">
                            <div class="task-list-title">${task.title}</div>
                            <div class="task-list-meta">
                                <span>üìå ${task.category}</span>
                                <span>üë§ ${assignedBadge}</span>
                                <span>üìä ${statusLabel}</span>
                                ${task.dueDate ? `<span>üìÖ ${new Date(task.dueDate).toLocaleDateString()}</span>` : ''}
                            </div>
                        </div>
                    `;
                });
                contentEl.innerHTML = html;
            }
            
            document.getElementById('taskListModal').classList.add('active');
        }

        function closeTaskListModal() {
            document.getElementById('taskListModal').classList.remove('active');
        }

        function switchView(tab) {
            console.log('Switching to tab:', tab);
            
            // Hide all views
            document.querySelectorAll('.tab-view').forEach(v => v.classList.remove('active'));
            
            // Deactivate all buttons
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            // Show selected view
            const view = document.getElementById(tab);
            if (view) {
                view.classList.add('active');
            }
            
            // Activate clicked button
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // Force refresh by redisplaying tasks
            console.log('Refreshing task display...');
            displayTasks();
        }

        window.addEventListener('load', () => {
            console.log('Page loading...');
            
            // 1. Load default tasks immediately
            loadDefaultTasks();
            console.log('Default tasks loaded:', tasks.length);
            
            // 2. Display them right away
            displayTasks();
            console.log('Tasks displayed');
            
            // 3. Ensure Firebase URL is clean
            databaseURL = databaseURL.replace(/\/tasks\.json$/, '');
            console.log('Firebase URL ready:', databaseURL);
            
            // Close modal on Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeEditModal();
                    closeTaskListModal();
                }
            });

            // Close modal when clicking outside
            document.addEventListener('click', function(e) {
                const editModal = document.getElementById('editModal');
                const taskListModal = document.getElementById('taskListModal');
                
                if (e.target === editModal) {
                    closeEditModal();
                }
                if (e.target === taskListModal) {
                    closeTaskListModal();
                }
            });
            
            // Try to load from Firebase (non-blocking)
            fetch(databaseURL + '/tasks.json')
                .then(r => r.json())
                .then(data => {
                    if (data && typeof data === 'object' && Object.keys(data).length > 0) {
                        const firebaseTasks = Object.values(data).filter(t => t && typeof t === 'object');
                        
                        // Check if Firebase data is NEW format (has assigned field)
                        const isNewFormat = firebaseTasks.some(t => t.hasOwnProperty('assigned'));
                        
                        if (firebaseTasks.length > 0 && isNewFormat) {
                            console.log('‚úÖ Firebase has new format. Loading:', firebaseTasks.length, 'tasks');
                            tasks = firebaseTasks;
                            nextId = Math.max(...tasks.map(t => t.id || 0)) + 1;
                            displayTasks();
                        } else {
                            console.log('‚ö†Ô∏è Firebase has OLD format. Using local defaults instead.');
                            // Don't load Firebase data - keep using defaults
                        }
                    }
                })
                .catch(e => console.log('Firebase not available - using local defaults'));

            // Continuous sync every 5 seconds
            setInterval(() => {
                if (databaseURL) {
                    fetch(databaseURL + '/tasks.json')
                        .then(r => r.json())
                        .then(data => {
                            if (data && typeof data === 'object' && Object.keys(data).length > 0) {
                                const firebaseTasks = Object.values(data).filter(t => t && typeof t === 'object');
                                
                                // Only sync if Firebase has NEW format
                                const isNewFormat = firebaseTasks.some(t => t.hasOwnProperty('assigned'));
                                
                                if (firebaseTasks.length > 0 && isNewFormat) {
                                    tasks = firebaseTasks;
                                    nextId = Math.max(...tasks.map(t => t.id || 0)) + 1;
                                    displayTasks();
                                }
                            }
                        })
                        .catch(e => null);
                }
            }, 5000);
        });
    </script>
</body>
</html>
