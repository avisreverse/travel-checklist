<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>India Travel Checklist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref as dbRef, set, get, remove, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBaKE82AGYYb4aYNHcbU345mf7lzTFEZmI",
            authDomain: "travel-checklist-a6682.firebaseapp.com",
            databaseURL: "https://travel-checklist-a6682-default-rtdb.firebaseio.com",
            projectId: "travel-checklist-a6682",
            storageBucket: "travel-checklist-a6682.appspot.com",
            messagingSenderId: "1044217540304",
            appId: "1:1044217540304:web:9758a4feb663366fbef8d5",
            measurementId: "G-RJLCYK1HGP"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Make globally available
        window.firebaseDatabase = database;
        window.firebaseDbRef = dbRef;
        window.firebaseSet = set;
        window.firebaseGet = get;
        window.firebaseRemove = remove;
        window.firebaseOnValue = onValue;

        console.log('âœ… Firebase initialized (Realtime Database)');
    </script>

    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f0f2f5;
            margin: 0;
            padding: 0;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 20px;
            text-align: center;
        }

        .header h1 { font-size: 28px; font-weight: 800; margin: 0; }
        .header p { font-size: 14px; opacity: 0.9; margin: 5px 0 0 0; }

        .container { max-width: 1200px; margin: 0 auto; background: white; min-height: 100vh; }

        .nav-container {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 15px 20px;
            border-bottom: 2px solid #e5e7eb;
            -webkit-overflow-scrolling: touch;
        }

        .nav-container::-webkit-scrollbar { height: 4px; }
        .nav-container::-webkit-scrollbar-thumb { background: #667eea; border-radius: 2px; }

        .nav-btn {
            padding: 10px 16px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            white-space: nowrap;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .nav-btn:hover { border-color: #667eea; background: #f0f4ff; }
        .nav-btn.active { background: #667eea; color: white; border-color: #667eea; }

        .content { padding: 20px; }

        .tab-view { display: none; }
        .tab-view.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* DASHBOARD SECTION */
        .dashboard-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 12px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            border: 2px solid #e5e7eb;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        .stat-progress {
            font-size: 12px;
            color: #999;
            margin-top: 8px;
            font-weight: 600;
            padding-top: 8px;
            border-top: 1px solid #f0f0f0;
        }

        .stat-card.completed { border-left-color: #10b981; }
        .stat-card.in-progress { border-left-color: #f59e0b; }
        .stat-card.waiting { border-left-color: #8b5cf6; }
        .stat-card.not-started { border-left-color: #ef4444; }
        .stat-card.overdue { border-left-color: #dc2626; }
        .stat-card.siva { border-left-color: #3b82f6; }
        .stat-card.priya { border-left-color: #ec4899; }
        .stat-card.both { border-left-color: #8b5cf6; }
        .stat-card.not-assigned { border-left-color: #999; }

        .stat-number { font-size: 32px; font-weight: 800; color: #667eea; margin: 5px 0; }
        .stat-label { font-size: 12px; color: #666; font-weight: 600; }

        /* CATEGORY SECTION */
        .category-section {
            margin-bottom: 30px;
        }

        .category-header {
            font-size: 16px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 15px;
            padding: 12px 15px;
            background: #f0f4ff;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }

        .add-task-form {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e5e7eb;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 10px;
            align-items: end;
        }

        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-bottom: 5px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
        }

        .btn-add {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
        }

        .btn-add:hover { background: #764ba2; }

        /* TASK CARD */
        .task-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .task-item.completed {
            opacity: 0.6;
            background: #f0fdf4;
            border-left-color: #10b981;
        }

        .task-item.overdue {
            background: #fef2f2;
            border-left-color: #dc2626;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
            flex-wrap: wrap;
        }

        .task-title {
            font-weight: 600;
            color: #1a1a1a;
            font-size: 14px;
        }

        .task-item.completed .task-title {
            text-decoration: line-through;
            color: #999;
        }

        .task-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            color: white;
        }

        .task-badge.siva { background: #3b82f6; }
        .task-badge.priya { background: #ec4899; }
        .task-badge.both { background: #8b5cf6; }
        .task-badge.not-assigned { background: #999; }

        .task-controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto auto;
            gap: 8px;
            align-items: center;
            margin-top: 10px;
        }

        .task-controls select,
        .task-controls input {
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            font-family: inherit;
        }

        .btn-edit {
            padding: 6px 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            opacity: 0.8;
            transition: all 0.2s;
        }

        .btn-edit:hover {
            opacity: 1;
        }

        /* DOCUMENT MANAGEMENT STYLES */
        .doc-upload-area {
            background: #f9fafb;
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .doc-upload-area:hover {
            background: #f0f4ff;
            border-color: #764ba2;
        }

        .doc-upload-area.dragover {
            background: #e0e7ff;
            border-color: #764ba2;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 48px;
            color: #667eea;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 16px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
        }

        .upload-subtext {
            font-size: 13px;
            color: #999;
        }

        .doc-filters {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto auto;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .view-toggle {
            display: flex;
            gap: 8px;
        }

        .view-btn {
            padding: 8px 12px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-btn:hover {
            background: #f0f4ff;
            border-color: #667eea;
        }

        .view-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .doc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .doc-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s;
            border-left: 4px solid #667eea;
        }

        .doc-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.1);
            border-color: #764ba2;
        }

        .doc-icon {
            font-size: 36px;
            text-align: center;
            margin-bottom: 12px;
        }

        .doc-name {
            font-weight: 600;
            font-size: 14px;
            color: #1a1a1a;
            margin-bottom: 8px;
            word-break: break-word;
        }

        .doc-meta {
            font-size: 11px;
            color: #999;
            margin-bottom: 5px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .doc-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #f0f0f0;
        }

        .doc-btn {
            flex: 1;
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .doc-btn.view {
            background: #667eea;
            color: white;
        }

        .doc-btn.view:hover {
            background: #764ba2;
        }

        .doc-btn.delete {
            background: #fee2e2;
            color: #dc2626;
        }

        .doc-btn.delete:hover {
            background: #dc2626;
            color: white;
        }

        .doc-list {
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .doc-list-item {
            border-bottom: 1px solid #e5e7eb;
            padding: 15px;
            display: grid;
            grid-template-columns: 40px minmax(200px, 2fr) 100px 100px 100px 120px 180px;
            gap: 12px;
            align-items: center;
            transition: all 0.2s;
        }

        .doc-list-item:hover {
            background: #f9fafb;
        }

        .doc-list-item:last-child {
            border-bottom: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* TASK LIST MODAL */
        .modal-content.large {
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content.large .modal-body {
            max-height: calc(80vh - 150px);
            overflow-y: auto;
        }

        .task-list-item {
            background: #f9fafb;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .task-list-item.completed {
            background: #f0fdf4;
            border-left-color: #10b981;
            opacity: 0.7;
        }

        .task-list-item.in-progress {
            background: #fffbeb;
            border-left-color: #f59e0b;
        }

        .task-list-item.waiting {
            background: #f3f4f6;
            border-left-color: #8b5cf6;
        }

        .task-list-item.not-started {
            background: #fef2f2;
            border-left-color: #ef4444;
        }

        .task-list-item.overdue {
            background: #fee2e2;
            border-left-color: #dc2626;
        }

        .task-list-title {
            font-weight: 600;
            color: #1a1a1a;
            font-size: 14px;
            margin-bottom: 6px;
        }

        .task-list-meta {
            font-size: 12px;
            color: #666;
            display: flex;
            gap: 15px;
        }

        .modal-header {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #667eea;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-body label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
        }

        .modal-body textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            min-height: 100px;
            box-sizing: border-box;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn-modal {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
        }

        .btn-save {
            background: #667eea;
            color: white;
        }

        .btn-save:hover {
            background: #764ba2;
        }

        .btn-cancel {
            background: #e5e7eb;
            color: #666;
        }

        .btn-cancel:hover {
            background: #d1d5db;
        }

        .task-meta {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
        }

        .task-meta.overdue { color: #dc2626; font-weight: 600; }

        /* MOBILE */
        @media (max-width: 768px) {
            .header h1 { font-size: 22px; }
            .stats-row { grid-template-columns: repeat(2, 1fr); }
            .form-grid { grid-template-columns: 1fr; }
            .task-controls { grid-template-columns: 1fr 1fr; }
            .stat-number { font-size: 24px; }
            .nav-container { flex-wrap: wrap; justify-content: center; }
            .nav-btn { font-size: 11px; padding: 8px 12px; flex: 1 1 auto; min-width: auto; }
            .category-header { font-size: 14px; word-wrap: break-word; white-space: normal; }
            .add-task-form { padding: 12px; }
            .btn-add { width: 100%; }
            .task-controls { grid-template-columns: 1fr; }
            .btn-edit, .btn-delete { width: 100%; }
            .doc-grid { grid-template-columns: 1fr; }
            .doc-filters { grid-template-columns: 1fr; }
            .doc-list-item { grid-template-columns: 40px 1fr 120px; font-size: 12px; }
            .doc-list-item .doc-meta { display: none; }
            .doc-list-item > div:nth-child(6) { display: none; } /* Hide expiration date on mobile */
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>âœˆï¸ India Travel Checklist</h1>
        <p>Family Trip Nov 22 - Dec 15 | Cloud Synced</p>
    </div>

    <div class="container">
        <!-- NAVIGATION -->
        <div class="nav-container">
            <button class="nav-btn active" onclick="switchView('dashboard')">ğŸ“Š Dashboard</button>
            <button class="nav-btn" onclick="switchView('doc-manager')">ğŸ“‚ Docs</button>
            <button class="nav-btn" onclick="switchView('critical')">ğŸ”´ Critical</button>
            <button class="nav-btn" onclick="switchView('documents')">ğŸ“„ Documents</button>
            <button class="nav-btn" onclick="switchView('financial')">ğŸ’³ Financial</button>
            <button class="nav-btn" onclick="switchView('employer')">ğŸ‘” Employer</button>
            <button class="nav-btn" onclick="switchView('school')">ğŸ“š School</button>
            <button class="nav-btn" onclick="switchView('home')">ğŸ  Home</button>
            <button class="nav-btn" onclick="switchView('medical')">âš•ï¸ Medical</button>
            <button class="nav-btn" onclick="switchView('india')">ğŸ‡®ğŸ‡³ India</button>
            <button class="nav-btn" onclick="switchView('packing')">ğŸ’ Packing</button>
            <button class="nav-btn" onclick="switchView('final')">âœ… Final</button>
        </div>

        <div class="content">
            <div style="text-align: right; padding: 10px 20px; border-bottom: 1px solid #e5e7eb;">
                <button onclick="openSettings()" title="Advanced settings" style="padding: 6px 12px; background: transparent; color: #999; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 14px; transition: all 0.3s;" onmouseover="this.style.background='#f5f5f5'; this.style.color='#667eea';" onmouseout="this.style.background='transparent'; this.style.color='#999';">âš™ï¸</button>
            </div>

            <!-- UPLOAD MODAL -->
            <div id="uploadModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">ğŸ“¤ Upload Documents</div>
                    <div class="modal-body">
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label>Document Name</label>
                            <input type="text" id="docName" placeholder="e.g., H1B Passport - Siva" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label>Person</label>
                            <select id="docPerson" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                <option value="">Select Person</option>
                                <option value="Siva">ğŸ‘¨ Siva</option>
                                <option value="Priya">ğŸ‘© Priya</option>
                                <option value="Akhil">ğŸ‘¦ Akhil</option>
                                <option value="Iniya">ğŸ‘§ Iniya</option>
                                <option value="Family">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Family</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label style="display: flex; justify-content: space-between; align-items: center;">
                                <span>Category</span>
                                <button type="button" onclick="openCategoryManager()" style="background: transparent; border: none; color: #667eea; font-size: 11px; cursor: pointer; text-decoration: underline;">Manage Categories</button>
                            </label>
                            <select id="docCategory" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                <option value="">Select Category</option>
                                <option value="Passport">ğŸ›‚ Passport</option>
                                <option value="Visa">ğŸ“‹ Visa</option>
                                <option value="Tickets">ğŸ« Tickets</option>
                                <option value="Medical">âš•ï¸ Medical</option>
                                <option value="Insurance">ğŸ¥ Insurance</option>
                                <option value="Financial">ğŸ’³ Financial</option>
                                <option value="School">ğŸ“š School</option>
                                <option value="Work">ğŸ‘” Work</option>
                                <option value="Other">ğŸ“ Other</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; flex-wrap: wrap;">
                                <input type="checkbox" id="docHasExpiration" onchange="toggleExpirationDate()" style="cursor: pointer; flex-shrink: 0;">
                                <span style="white-space: nowrap;">This document expires</span>
                            </label>
                            <div id="expirationDateField" style="display: none; margin-top: 8px;">
                                <input type="date" id="docExpirationDate" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                            </div>
                        </div>
                        <div id="uploadProgress" style="display: none;">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                            </div>
                            <div style="text-align: center; margin-top: 8px; font-size: 12px; color: #667eea; font-weight: 600;" id="progressText">Uploading... 0%</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-modal btn-cancel" onclick="closeUploadModal()">Cancel</button>
                        <button class="btn-modal btn-save" onclick="uploadDocuments()" id="uploadBtn">Upload</button>
                    </div>
                </div>
            </div>

            <!-- EDIT MODAL -->
            <div id="editModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">âœï¸ Edit Task</div>
                    <div class="modal-body">
                        <label>Task Description</label>
                        <textarea id="editTaskTitle" placeholder="Enter task description..."></textarea>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-modal btn-cancel" onclick="closeEditModal()">Cancel</button>
                        <button class="btn-modal btn-save" onclick="saveTaskEdit()">Save Changes</button>
                    </div>
                </div>
            </div>

            <!-- TASK LIST MODAL -->
            <div id="taskListModal" class="modal">
                <div class="modal-content large">
                    <div class="modal-header" id="taskListTitle">ğŸ“‹ Tasks</div>
                    <div class="modal-body" id="taskListContent">
                        <!-- Tasks will be inserted here -->
                    </div>
                    <div class="modal-footer">
                        <button class="btn-modal btn-cancel" onclick="closeTaskListModal()">Close</button>
                    </div>
                </div>
            </div>

            <!-- SETTINGS MODAL -->
            <div id="settingsModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">âš™ï¸ Settings</div>
                    <div class="modal-body">
                        <div style="background: #fef2f2; padding: 15px; border-radius: 6px; border-left: 4px solid #dc2626; margin-bottom: 20px;">
                            <div style="font-weight: 600; color: #dc2626; margin-bottom: 8px;">âš ï¸ Danger Zone</div>
                            <div style="font-size: 13px; color: #666; line-height: 1.5;">
                                This action will DELETE all Firebase data and reset with default tasks. This CANNOT be undone.
                            </div>
                        </div>
                        <button onclick="openResetConfirm()" style="width: 100%; padding: 12px; background: #dc2626; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">ğŸ”„ Clear Firebase Data</button>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-modal btn-cancel" onclick="closeSettings()">Close</button>
                    </div>
                </div>
            </div>

            <!-- RESET CONFIRMATION MODAL -->
            <div id="resetConfirmModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header" style="color: #dc2626;">ğŸš¨ Confirm Reset</div>
                    <div class="modal-body">
                        <div style="background: #fee2e2; padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #dc2626;">
                            <div style="font-weight: 600; color: #991b1b; margin-bottom: 10px;">This will permanently delete ALL your data!</div>
                            <div style="font-size: 13px; color: #991b1b; line-height: 1.6;">
                                âœ— All tasks will be deleted<br/>
                                âœ— All assignments will be removed<br/>
                                âœ— All progress will be lost<br/>
                                âœ“ Default tasks will be restored<br/><br/>
                                <strong>This action CANNOT be undone.</strong>
                            </div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-size: 13px; font-weight: 600; color: #666; margin-bottom: 8px;">Type "RESET" to confirm:</label>
                            <input type="text" id="resetConfirmInput" placeholder="Type RESET here..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;" />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-modal btn-cancel" onclick="closeResetConfirm()">Cancel</button>
                        <button class="btn-modal" id="resetConfirmBtn" style="background: #dc2626; color: white; opacity: 0.5; cursor: not-allowed;" onclick="confirmReset()" disabled>Delete All Data</button>
                    </div>
                </div>
            </div>

            <!-- DOCUMENT VIEWER MODAL -->
            <div id="docViewerModal" class="modal">
                <div class="modal-content" style="max-width: 90vw; max-height: 90vh; width: 900px; padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div class="modal-header" id="docViewerTitle" style="margin: 0;">ğŸ“„ Document Viewer</div>
                        <button onclick="closeDocViewer()" style="background: #e5e7eb; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 18px; line-height: 1;">Ã—</button>
                    </div>
                    <div id="docViewerContent" style="width: 100%; height: 70vh; overflow: auto; background: #f9fafb; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        <!-- Document content will be inserted here -->
                    </div>
                    <div class="modal-footer" style="margin-top: 15px;">
                        <button class="btn-modal btn-cancel" onclick="closeDocViewer()">Close</button>
                        <button class="btn-modal btn-save" onclick="downloadCurrentDoc()" id="downloadDocBtn">â¬‡ï¸ Download</button>
                    </div>
                </div>
            </div>

            <!-- EDIT DOCUMENT MODAL -->
            <div id="editDocModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">âœï¸ Edit Document</div>
                    <div class="modal-body">
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label>Document Name</label>
                            <input type="text" id="editDocName" placeholder="Document name..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label>Person</label>
                            <select id="editDocPerson" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                <option value="">Select Person</option>
                                <option value="Siva">ğŸ‘¨ Siva</option>
                                <option value="Priya">ğŸ‘© Priya</option>
                                <option value="Akhil">ğŸ‘¦ Akhil</option>
                                <option value="Iniya">ğŸ‘§ Iniya</option>
                                <option value="Family">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Family</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label>Category</label>
                            <select id="editDocCategory" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                <!-- Categories will be populated dynamically -->
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; flex-wrap: wrap;">
                                <input type="checkbox" id="editDocHasExpiration" onchange="toggleEditExpirationDate()" style="cursor: pointer; flex-shrink: 0;">
                                <span style="white-space: nowrap;">This document expires</span>
                            </label>
                            <div id="editExpirationDateField" style="display: none; margin-top: 8px;">
                                <input type="date" id="editDocExpirationDate" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-modal btn-cancel" onclick="closeEditDocModal()">Cancel</button>
                        <button class="btn-modal btn-save" onclick="saveDocEdit()">Save Changes</button>
                    </div>
                </div>
            </div>

            <!-- CATEGORY MANAGER MODAL -->
            <div id="categoryManagerModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">ğŸ·ï¸ Manage Categories</div>
                    <div class="modal-body">
                        <div style="margin-bottom: 20px;">
                            <label style="font-size: 13px; font-weight: 600; color: #666; margin-bottom: 8px; display: block;">Add New Category</label>
                            <div style="display: flex; gap: 8px;">
                                <input type="text" id="newCategoryName" placeholder="Category name..." style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                <button onclick="addCustomCategory()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; white-space: nowrap;">â• Add</button>
                            </div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="font-size: 13px; font-weight: 600; color: #666; margin-bottom: 8px; display: block;">Default Categories</label>
                            <div style="font-size: 12px; color: #999; background: #f9fafb; padding: 12px; border-radius: 6px; line-height: 1.8;">
                                ğŸ›‚ Passport | ğŸ“‹ Visa | ğŸ« Tickets | âš•ï¸ Medical | ğŸ¥ Insurance | ğŸ’³ Financial | ğŸ“š School | ğŸ‘” Work | ğŸ“ Other
                            </div>
                        </div>
                        <div>
                            <label style="font-size: 13px; font-weight: 600; color: #666; margin-bottom: 8px; display: block;">Custom Categories</label>
                            <div id="customCategoriesList" style="max-height: 200px; overflow-y: auto;">
                                <!-- Custom categories will be listed here -->
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-modal btn-cancel" onclick="closeCategoryManager()">Close</button>
                    </div>
                </div>
            </div>

            <!-- DOCUMENT LIST MODAL -->
            <div id="documentListModal" class="modal">
                <div class="modal-content large">
                    <div class="modal-header" id="documentListTitle">ğŸ“‚ Documents</div>
                    <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                        <div id="documentListContent">
                            <!-- Documents will be displayed here -->
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-modal btn-cancel" onclick="closeDocumentListModal()">Close</button>
                    </div>
                </div>
            </div>

            <!-- DOCUMENT MANAGER TAB -->
            <div id="doc-manager" class="tab-view">
                <div class="section-title">ğŸ“‚ Document Manager</div>

                <!-- Upload Area -->
                <input type="file" id="fileInput" multiple style="display: none;" onchange="handleFileSelect(event)">
                <div class="doc-upload-area" onclick="document.getElementById('fileInput').click()"
                     ondrop="handleDrop(event)"
                     ondragover="handleDragOver(event)"
                     ondragleave="handleDragLeave(event)">
                    <div class="upload-icon">ğŸ“¤</div>
                    <div class="upload-text">Click or Drag Files to Upload</div>
                    <div class="upload-subtext">All file types â€¢ Up to 10MB per file â€¢ Multiple files allowed</div>
                </div>

                <!-- Filters -->
                <div class="doc-filters">
                    <div class="form-group">
                        <input type="text" id="searchDoc" placeholder="ğŸ” Search documents..." oninput="filterDocuments()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                    <div class="form-group">
                        <select id="filterPerson" onchange="filterDocuments()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                            <option value="">ğŸ‘¤ All People</option>
                            <option value="Siva">Siva</option>
                            <option value="Priya">Priya</option>
                            <option value="Akhil">Akhil</option>
                            <option value="Iniya">Iniya</option>
                            <option value="Family">Family</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <select id="filterType" onchange="filterDocuments()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                            <option value="">ğŸ“„ All Types</option>
                            <option value="pdf">PDF</option>
                            <option value="image">Image</option>
                            <option value="doc">Document</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <select id="filterCategory" onchange="filterDocuments()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                            <option value="">ğŸ·ï¸ All Categories</option>
                            <option value="Passport">Passport</option>
                            <option value="Visa">Visa</option>
                            <option value="Tickets">Tickets</option>
                            <option value="Medical">Medical</option>
                            <option value="Insurance">Insurance</option>
                            <option value="Financial">Financial</option>
                            <option value="School">School</option>
                            <option value="Work">Work</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="view-toggle">
                        <button class="view-btn active" onclick="setViewMode('grid')" id="gridViewBtn">
                            <i class="fas fa-th"></i>
                        </button>
                        <button class="view-btn" onclick="setViewMode('list')" id="listViewBtn">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                </div>

                <!-- Document Display -->
                <div id="docDisplay"></div>
            </div>

            <!-- DASHBOARD -->
            <div id="dashboard" class="tab-view active">
                <!-- Task Status Dashboard -->
                <div class="dashboard-section">
                    <div class="section-title">ğŸ“Š Task Status Overview</div>
                    <div class="stats-row">
                        <div class="stat-card completed">
                            <div class="stat-number" id="stat-completed">0</div>
                            <div class="stat-label">âœ… Completed</div>
                        </div>
                        <div class="stat-card in-progress">
                            <div class="stat-number" id="stat-in-progress">0</div>
                            <div class="stat-label">ğŸ”„ In Progress</div>
                        </div>
                        <div class="stat-card waiting">
                            <div class="stat-number" id="stat-waiting">0</div>
                            <div class="stat-label">â³ Waiting</div>
                        </div>
                        <div class="stat-card not-started">
                            <div class="stat-number" id="stat-not-started">0</div>
                            <div class="stat-label">ğŸ“‹ Not Started</div>
                        </div>
                        <div class="stat-card overdue">
                            <div class="stat-number" id="stat-overdue">0</div>
                            <div class="stat-label">âš ï¸ Overdue</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="stat-total">0</div>
                            <div class="stat-label">ğŸ“ Total</div>
                        </div>
                    </div>
                </div>

                <!-- Assignee Dashboard -->
                <div class="dashboard-section">
                    <div class="section-title">ğŸ‘¥ Tasks by Assignee</div>
                    <div class="stats-row">
                        <div class="stat-card siva">
                            <div class="stat-number" id="stat-siva-progress" style="font-size: 32px; font-weight: 800; color: #667eea; margin: 5px 0;">0/0</div>
                            <div class="stat-label">ğŸ‘¨ Siva</div>
                            <div class="stat-progress" style="font-size: 11px; color: #999;">completed</div>
                        </div>
                        <div class="stat-card priya">
                            <div class="stat-number" id="stat-priya-progress" style="font-size: 32px; font-weight: 800; color: #667eea; margin: 5px 0;">0/0</div>
                            <div class="stat-label">ğŸ‘© Priya</div>
                            <div class="stat-progress" style="font-size: 11px; color: #999;">completed</div>
                        </div>
                        <div class="stat-card both">
                            <div class="stat-number" id="stat-both-progress" style="font-size: 32px; font-weight: 800; color: #667eea; margin: 5px 0;">0/0</div>
                            <div class="stat-label">ğŸ‘¥ Both</div>
                            <div class="stat-progress" style="font-size: 11px; color: #999;">completed</div>
                        </div>
                        <div class="stat-card not-assigned">
                            <div class="stat-number" id="stat-not-assigned-progress" style="font-size: 32px; font-weight: 800; color: #667eea; margin: 5px 0;">0/0</div>
                            <div class="stat-label">â“ Not Assigned</div>
                            <div class="stat-progress" style="font-size: 11px; color: #999;">completed</div>
                        </div>
                    </div>
                </div>

                <!-- Document Expiration Dashboard -->
                <div class="dashboard-section">
                    <div class="section-title">ğŸ“„ Document Expiration Status</div>
                    <div class="stats-row">
                        <div class="stat-card" style="border-left-color: #dc2626; cursor: pointer;" onclick="showDocumentsByExpiration('expired', 'ğŸ”´ Expired Documents')">
                            <div class="stat-number" id="stat-doc-expired">0</div>
                            <div class="stat-label">ğŸ”´ Expired</div>
                        </div>
                        <div class="stat-card" style="border-left-color: #f59e0b; cursor: pointer;" onclick="showDocumentsByExpiration('expiring-soon', 'âš ï¸ Documents Expiring Soon')">
                            <div class="stat-number" id="stat-doc-expiring-soon">0</div>
                            <div class="stat-label">âš ï¸ Expiring Soon</div>
                            <div class="stat-progress">within 30 days</div>
                        </div>
                        <div class="stat-card" style="border-left-color: #10b981; cursor: pointer;" onclick="showDocumentsByExpiration('valid', 'âœ… Valid Documents')">
                            <div class="stat-number" id="stat-doc-valid">0</div>
                            <div class="stat-label">âœ… Valid</div>
                        </div>
                        <div class="stat-card" style="cursor: pointer;" onclick="showDocumentsByExpiration('no-expiration', 'ğŸ“ Documents Without Expiration')">
                            <div class="stat-number" id="stat-doc-no-expiration">0</div>
                            <div class="stat-label">ğŸ“ No Expiration</div>
                        </div>
                        <div class="stat-card" style="cursor: pointer;" onclick="showDocumentsByExpiration('all', 'ğŸ“‚ All Documents')">
                            <div class="stat-number" id="stat-doc-total">0</div>
                            <div class="stat-label">ğŸ“‚ Total Docs</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CATEGORIES -->
            <div id="critical" class="tab-view"></div>
            <div id="documents" class="tab-view"></div>
            <div id="financial" class="tab-view"></div>
            <div id="employer" class="tab-view"></div>
            <div id="school" class="tab-view"></div>
            <div id="home" class="tab-view"></div>
            <div id="medical" class="tab-view"></div>
            <div id="india" class="tab-view"></div>
            <div id="packing" class="tab-view"></div>
            <div id="final" class="tab-view"></div>
        </div>
    </div>

    <script>
        let tasks = [];
        let nextId = 1;
        let databaseURL = 'https://travel-checklist-a6682-default-rtdb.firebaseio.com';
        let isUserTyping = false;
        let allDocuments = [];
        let selectedFiles = [];
        let currentViewMode = 'grid';
        let currentDocData = null;
        let currentDocFileName = null;
        let customCategories = [];
        let editingDocId = null;

        const categoryMap = {
            'critical': 'ğŸ”´ CRITICAL - DO THIS FIRST',
            'documents': 'ğŸ“„ DOCUMENTS TO PREPARE',
            'financial': 'ğŸ’³ FINANCIAL & BANKING',
            'employer': 'ğŸ‘” EMPLOYER & WORK',
            'school': 'ğŸ“š SCHOOL & FAMILY',
            'home': 'ğŸ  HOME PREPARATION',
            'medical': 'âš•ï¸ MEDICAL PREPARATIONS',
            'india': 'ğŸ‡®ğŸ‡³ INDIA PREPARATIONS',
            'packing': 'ğŸ’ PACKING CHECKLIST',
            'final': 'âœ… FINAL PREPARATIONS'
        };

        const defaultCategories = [
            {value: 'Passport', label: 'ğŸ›‚ Passport'},
            {value: 'Visa', label: 'ğŸ“‹ Visa'},
            {value: 'Tickets', label: 'ğŸ« Tickets'},
            {value: 'Medical', label: 'âš•ï¸ Medical'},
            {value: 'Insurance', label: 'ğŸ¥ Insurance'},
            {value: 'Financial', label: 'ğŸ’³ Financial'},
            {value: 'School', label: 'ğŸ“š School'},
            {value: 'Work', label: 'ğŸ‘” Work'},
            {value: 'Other', label: 'ğŸ“ Other'}
        ];

        // ==================== HELPER FUNCTIONS ====================

        function calculateDaysUntilExpiration(expirationDate) {
            if (!expirationDate) return null;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const expDate = new Date(expirationDate);
            expDate.setHours(0, 0, 0, 0);
            const diffTime = expDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        function getExpirationLabel(expirationDate) {
            if (!expirationDate) return null;
            const days = calculateDaysUntilExpiration(expirationDate);

            if (days < 0) {
                const absDays = Math.abs(days);
                return {
                    text: `Expired ${absDays} day${absDays !== 1 ? 's' : ''} ago`,
                    color: '#dc2626',
                    bgColor: '#fee2e2',
                    status: 'expired'
                };
            } else if (days === 0) {
                return {
                    text: 'Expires today',
                    color: '#dc2626',
                    bgColor: '#fee2e2',
                    status: 'expired'
                };
            } else if (days <= 30) {
                return {
                    text: `Expires in ${days} day${days !== 1 ? 's' : ''}`,
                    color: '#f59e0b',
                    bgColor: '#fef3c7',
                    status: 'expiring-soon'
                };
            } else {
                return {
                    text: `Expires in ${days} days`,
                    color: '#10b981',
                    bgColor: '#d1fae5',
                    status: 'valid'
                };
            }
        }

        function toggleExpirationDate() {
            const checkbox = document.getElementById('docHasExpiration');
            const field = document.getElementById('expirationDateField');
            field.style.display = checkbox.checked ? 'block' : 'none';
        }

        function toggleEditExpirationDate() {
            const checkbox = document.getElementById('editDocHasExpiration');
            const field = document.getElementById('editExpirationDateField');
            field.style.display = checkbox.checked ? 'block' : 'none';
        }

        // ==================== DOCUMENT MANAGEMENT ====================

        function handleFileSelect(event) {
            selectedFiles = Array.from(event.target.files);
            if (selectedFiles.length > 0) {
                openUploadModal();
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }

        function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            selectedFiles = Array.from(event.dataTransfer.files);
            if (selectedFiles.length > 0) {
                openUploadModal();
            }
        }

        function openUploadModal() {
            document.getElementById('uploadModal').classList.add('active');
            document.getElementById('docName').value = selectedFiles.length === 1 ? selectedFiles[0].name : `${selectedFiles.length} files`;
            document.getElementById('docPerson').value = '';
            document.getElementById('docCategory').value = '';
            document.getElementById('docHasExpiration').checked = false;
            document.getElementById('docExpirationDate').value = '';
            document.getElementById('expirationDateField').style.display = 'none';
            document.getElementById('uploadProgress').style.display = 'none';
            populateCategoryDropdown('docCategory');
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').classList.remove('active');
            selectedFiles = [];
            document.getElementById('fileInput').value = '';
        }

        async function uploadDocuments() {
            const docName = document.getElementById('docName').value.trim();
            const person = document.getElementById('docPerson').value;
            const category = document.getElementById('docCategory').value;
            const hasExpiration = document.getElementById('docHasExpiration').checked;
            const expirationDate = hasExpiration ? document.getElementById('docExpirationDate').value : null;

            if (!docName || !person || !category) {
                alert('Please fill in all fields');
                return;
            }

            if (hasExpiration && !expirationDate) {
                alert('Please select an expiration date or uncheck the expiration option');
                return;
            }

            if (selectedFiles.length === 0) {
                alert('No files selected');
                return;
            }

            // Check file size limit (7MB per file - base64 encoding adds ~33% overhead, keeping total under 10MB Firebase limit)
            const maxSize = 7 * 1024 * 1024; // 7MB
            for (let file of selectedFiles) {
                if (file.size > maxSize) {
                    alert(`File "${file.name}" is too large. Maximum size is 7MB.\n\n(Files are encoded in base64 which increases size by ~33%. The 7MB limit ensures the encoded file stays under Firebase's 10MB limit.)`);
                    return;
                }
            }

            document.getElementById('uploadBtn').disabled = true;
            document.getElementById('uploadProgress').style.display = 'block';

            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                const timestamp = Date.now() + i;
                const fileName = file.name;

                try {
                    // Update progress
                    document.getElementById('progressFill').style.width = '30%';
                    document.getElementById('progressText').textContent = `Processing ${i + 1}/${selectedFiles.length}... 30%`;

                    // Convert file to base64
                    const base64Data = await fileToBase64(file);

                    document.getElementById('progressFill').style.width = '70%';
                    document.getElementById('progressText').textContent = `Uploading ${i + 1}/${selectedFiles.length}... 70%`;

                    const docData = {
                        id: 'doc_' + timestamp,
                        name: selectedFiles.length === 1 ? docName : `${docName} - ${fileName}`,
                        fileName: fileName,
                        fileType: getFileType(fileName),
                        fileSize: file.size,
                        person: person,
                        category: category,
                        uploadDate: new Date().toISOString(),
                        expirationDate: expirationDate,
                        fileData: base64Data
                    };

                    await window.firebaseSet(
                        window.firebaseDbRef(window.firebaseDatabase, 'documents/' + docData.id),
                        docData
                    );

                    document.getElementById('progressFill').style.width = '100%';
                    document.getElementById('progressText').textContent = `Uploaded ${i + 1}/${selectedFiles.length}... 100%`;

                    console.log('âœ… Document uploaded:', docData.name);

                } catch (error) {
                    console.error('Upload error:', error);
                    alert('Upload failed: ' + error.message);
                    document.getElementById('uploadBtn').disabled = false;
                    return;
                }
            }

            setTimeout(() => {
                closeUploadModal();
                loadDocuments();
                document.getElementById('uploadBtn').disabled = false;
            }, 500);
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function getFileType(fileName) {
            const ext = fileName.split('.').pop().toLowerCase();
            if (['pdf'].includes(ext)) return 'pdf';
            if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(ext)) return 'image';
            if (['doc', 'docx', 'txt', 'rtf'].includes(ext)) return 'doc';
            return 'other';
        }

        function getFileIcon(fileType) {
            switch (fileType) {
                case 'pdf': return 'ğŸ“•';
                case 'image': return 'ğŸ–¼ï¸';
                case 'doc': return 'ğŸ“';
                default: return 'ğŸ“„';
            }
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        async function loadDocuments() {
            try {
                const snapshot = await window.firebaseGet(
                    window.firebaseDbRef(window.firebaseDatabase, 'documents')
                );

                if (snapshot.exists()) {
                    allDocuments = Object.values(snapshot.val());
                } else {
                    allDocuments = [];
                }

                filterDocuments();
                updateDocumentExpirationStats();
                console.log('âœ… Loaded', allDocuments.length, 'documents');
            } catch (error) {
                console.error('Load documents error:', error);
            }
        }

        function updateDocumentExpirationStats() {
            let expired = 0;
            let expiringSoon = 0;
            let valid = 0;
            let noExpiration = 0;

            allDocuments.forEach(doc => {
                if (!doc.expirationDate) {
                    noExpiration++;
                } else {
                    const label = getExpirationLabel(doc.expirationDate);
                    if (label.status === 'expired') {
                        expired++;
                    } else if (label.status === 'expiring-soon') {
                        expiringSoon++;
                    } else if (label.status === 'valid') {
                        valid++;
                    }
                }
            });

            document.getElementById('stat-doc-expired').textContent = expired;
            document.getElementById('stat-doc-expiring-soon').textContent = expiringSoon;
            document.getElementById('stat-doc-valid').textContent = valid;
            document.getElementById('stat-doc-no-expiration').textContent = noExpiration;
            document.getElementById('stat-doc-total').textContent = allDocuments.length;
        }

        function filterDocuments() {
            const searchTerm = document.getElementById('searchDoc').value.toLowerCase();
            const filterPerson = document.getElementById('filterPerson').value;
            const filterType = document.getElementById('filterType').value;
            const filterCategory = document.getElementById('filterCategory').value;

            let filtered = allDocuments.filter(doc => {
                const matchSearch = !searchTerm || doc.name.toLowerCase().includes(searchTerm) || doc.fileName.toLowerCase().includes(searchTerm);
                const matchPerson = !filterPerson || doc.person === filterPerson;
                const matchType = !filterType || doc.fileType === filterType;
                const matchCategory = !filterCategory || doc.category === filterCategory;
                return matchSearch && matchPerson && matchType && matchCategory;
            });

            displayDocuments(filtered);
        }

        function displayDocuments(docs) {
            const container = document.getElementById('docDisplay');

            if (docs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“‚</div>
                        <div style="font-size: 16px; font-weight: 600; color: #999; margin-bottom: 8px;">No Documents Found</div>
                        <div style="font-size: 13px; color: #bbb;">Upload your first document to get started</div>
                    </div>
                `;
                return;
            }

            if (currentViewMode === 'grid') {
                let html = '<div class="doc-grid">';
                docs.forEach(doc => {
                    const expirationLabel = getExpirationLabel(doc.expirationDate);
                    const isExpired = expirationLabel && expirationLabel.status === 'expired';

                    html += `
                        <div class="doc-card" style="${isExpired ? 'border-left-color: #dc2626; background: #fef2f2;' : ''}">
                            <div class="doc-icon">${getFileIcon(doc.fileType)}</div>
                            <div class="doc-name">${doc.name}</div>
                            ${expirationLabel ? `
                                <div style="margin: 8px 0; padding: 6px 10px; border-radius: 4px; font-size: 11px; font-weight: 600; background: ${expirationLabel.bgColor}; color: ${expirationLabel.color}; text-align: center;">
                                    ${expirationLabel.text}
                                </div>
                            ` : ''}
                            <div class="doc-meta">
                                <span>ğŸ‘¤ ${doc.person}</span>
                                <span>ğŸ·ï¸ ${doc.category}</span>
                            </div>
                            <div class="doc-meta">
                                <span>ğŸ“¦ ${formatFileSize(doc.fileSize)}</span>
                                <span>ğŸ“… ${new Date(doc.uploadDate).toLocaleDateString()}</span>
                            </div>
                            <div class="doc-actions">
                                <button class="doc-btn view" onclick="viewDocument('${doc.id}', '${doc.fileName}')">ğŸ‘ï¸ View</button>
                                <button class="doc-btn" style="background: #e0e7ff; color: #667eea;" onclick="openEditDocModal('${doc.id}')">âœï¸ Edit</button>
                                <button class="doc-btn delete" onclick="deleteDocument('${doc.id}')">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            } else {
                let html = '<div class="doc-list">';
                docs.forEach(doc => {
                    const expirationLabel = getExpirationLabel(doc.expirationDate);
                    const isExpired = expirationLabel && expirationLabel.status === 'expired';

                    html += `
                        <div class="doc-list-item" style="${isExpired ? 'background: #fef2f2;' : ''}">
                            <div style="text-align: center; font-size: 24px;">${getFileIcon(doc.fileType)}</div>
                            <div>
                                <div style="font-weight: 600; color: #1a1a1a; margin-bottom: 4px;">${doc.name}</div>
                                ${expirationLabel ? `
                                    <div style="display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; background: ${expirationLabel.bgColor}; color: ${expirationLabel.color};">
                                        ${expirationLabel.text}
                                    </div>
                                ` : ''}
                            </div>
                            <div class="doc-meta"><span>ğŸ‘¤ ${doc.person}</span></div>
                            <div class="doc-meta"><span>ğŸ·ï¸ ${doc.category}</span></div>
                            <div class="doc-meta"><span>ğŸ“¦ ${formatFileSize(doc.fileSize)}</span></div>
                            <div style="font-size: 12px;">
                                ${doc.expirationDate ? `
                                    <div style="font-weight: 600; color: ${expirationLabel ? expirationLabel.color : '#666'};">ğŸ“… ${new Date(doc.expirationDate).toLocaleDateString()}</div>
                                ` : `<span style="color: #999;">No expiry</span>`}
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="doc-btn view" onclick="viewDocument('${doc.id}', '${doc.fileName}')">ğŸ‘ï¸ View</button>
                                <button class="doc-btn" style="background: #e0e7ff; color: #667eea;" onclick="openEditDocModal('${doc.id}')">âœï¸</button>
                                <button class="doc-btn delete" onclick="deleteDocument('${doc.id}')">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            }
        }

        function setViewMode(mode) {
            currentViewMode = mode;
            document.getElementById('gridViewBtn').classList.toggle('active', mode === 'grid');
            document.getElementById('listViewBtn').classList.toggle('active', mode === 'list');
            filterDocuments();
        }

        async function viewDocument(docId, fileName) {
            try {
                console.log('Opening document:', docId, fileName);

                // Get document from database
                const snapshot = await window.firebaseGet(
                    window.firebaseDbRef(window.firebaseDatabase, 'documents/' + docId)
                );

                if (snapshot.exists()) {
                    const doc = snapshot.val();
                    currentDocData = doc.fileData;
                    currentDocFileName = fileName;

                    console.log('Document loaded:', doc.name, 'Type:', doc.fileType, 'Size:', doc.fileSize);

                    // Display document in modal
                    const content = document.getElementById('docViewerContent');
                    document.getElementById('docViewerTitle').textContent = `ğŸ“„ ${doc.name}`;

                    // Display based on file type
                    if (doc.fileType === 'pdf') {
                        console.log('Rendering PDF');
                        content.innerHTML = `
                            <iframe src="${doc.fileData}" width="100%" height="100%" style="border: none;" title="${doc.name}"></iframe>
                        `;
                    } else if (doc.fileType === 'image') {
                        console.log('Rendering Image');
                        content.innerHTML = `<img src="${doc.fileData}" style="max-width: 100%; max-height: 100%; object-fit: contain;" alt="${doc.name}" />`;
                    } else if (doc.fileType === 'doc') {
                        console.log('Document type - showing download option');
                        // For documents, show download option
                        content.innerHTML = `
                            <div style="text-align: center; padding: 40px;">
                                <div style="font-size: 48px; margin-bottom: 20px;">${getFileIcon(doc.fileType)}</div>
                                <div style="font-size: 16px; font-weight: 600; color: #1a1a1a; margin-bottom: 10px;">${doc.name}</div>
                                <div style="font-size: 13px; color: #666; margin-bottom: 20px;">
                                    Preview not available for this document type.<br/>
                                    Click Download to view the file.
                                </div>
                                <button onclick="downloadCurrentDoc()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">â¬‡ï¸ Download Document</button>
                            </div>
                        `;
                    } else {
                        console.log('Other file type - attempting to display:', doc.fileType);
                        // For other file types, try to display in iframe or show download option
                        content.innerHTML = `
                            <div style="text-align: center; padding: 40px;">
                                <div style="font-size: 48px; margin-bottom: 20px;">${getFileIcon(doc.fileType)}</div>
                                <div style="font-size: 16px; font-weight: 600; color: #1a1a1a; margin-bottom: 10px;">${doc.name}</div>
                                <div style="font-size: 13px; color: #666; margin-bottom: 15px;">
                                    File: ${fileName}<br/>
                                    Type: ${doc.fileType}<br/>
                                    Size: ${formatFileSize(doc.fileSize)}
                                </div>
                                <div style="display: flex; gap: 10px; justify-content: center;">
                                    <button onclick="downloadCurrentDoc()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">â¬‡ï¸ Download</button>
                                    <button onclick="window.open(currentDocData, '_blank')" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">ğŸ”— Open in New Tab</button>
                                </div>
                            </div>
                        `;
                    }

                    // Open modal
                    document.getElementById('docViewerModal').classList.add('active');
                    console.log('Modal opened');
                } else {
                    alert('Document not found');
                }
            } catch (error) {
                console.error('View error:', error);
                alert('Failed to view document: ' + error.message);
            }
        }

        function closeDocViewer() {
            document.getElementById('docViewerModal').classList.remove('active');
            document.getElementById('docViewerContent').innerHTML = '';
            currentDocData = null;
            currentDocFileName = null;
        }

        function downloadCurrentDoc() {
            if (currentDocData && currentDocFileName) {
                const link = document.createElement('a');
                link.href = currentDocData;
                link.download = currentDocFileName;
                link.click();
                console.log('âœ… Document downloaded:', currentDocFileName);
            }
        }

        async function deleteDocument(docId) {
            if (!confirm('Delete this document permanently?')) return;

            try {
                // Delete from Database
                await window.firebaseRemove(
                    window.firebaseDbRef(window.firebaseDatabase, 'documents/' + docId)
                );

                console.log('âœ… Document deleted');
                loadDocuments();
            } catch (error) {
                console.error('Delete error:', error);
                alert('Failed to delete document: ' + error.message);
            }
        }

        // ==================== EDIT DOCUMENT ====================

        async function openEditDocModal(docId) {
            try {
                const snapshot = await window.firebaseGet(
                    window.firebaseDbRef(window.firebaseDatabase, 'documents/' + docId)
                );

                if (snapshot.exists()) {
                    const doc = snapshot.val();
                    editingDocId = docId;

                    document.getElementById('editDocName').value = doc.name;
                    document.getElementById('editDocPerson').value = doc.person;
                    populateCategoryDropdown('editDocCategory');
                    document.getElementById('editDocCategory').value = doc.category;

                    if (doc.expirationDate) {
                        document.getElementById('editDocHasExpiration').checked = true;
                        document.getElementById('editDocExpirationDate').value = doc.expirationDate;
                        document.getElementById('editExpirationDateField').style.display = 'block';
                    } else {
                        document.getElementById('editDocHasExpiration').checked = false;
                        document.getElementById('editDocExpirationDate').value = '';
                        document.getElementById('editExpirationDateField').style.display = 'none';
                    }

                    document.getElementById('editDocModal').classList.add('active');
                }
            } catch (error) {
                console.error('Error opening edit modal:', error);
                alert('Failed to load document: ' + error.message);
            }
        }

        function closeEditDocModal() {
            document.getElementById('editDocModal').classList.remove('active');
            editingDocId = null;
        }

        async function saveDocEdit() {
            if (!editingDocId) return;

            const name = document.getElementById('editDocName').value.trim();
            const person = document.getElementById('editDocPerson').value;
            const category = document.getElementById('editDocCategory').value;
            const hasExpiration = document.getElementById('editDocHasExpiration').checked;
            const expirationDate = hasExpiration ? document.getElementById('editDocExpirationDate').value : null;

            if (!name || !person || !category) {
                alert('Please fill in all required fields');
                return;
            }

            if (hasExpiration && !expirationDate) {
                alert('Please select an expiration date or uncheck the expiration option');
                return;
            }

            try {
                const snapshot = await window.firebaseGet(
                    window.firebaseDbRef(window.firebaseDatabase, 'documents/' + editingDocId)
                );

                if (snapshot.exists()) {
                    const doc = snapshot.val();
                    doc.name = name;
                    doc.person = person;
                    doc.category = category;
                    doc.expirationDate = expirationDate;

                    await window.firebaseSet(
                        window.firebaseDbRef(window.firebaseDatabase, 'documents/' + editingDocId),
                        doc
                    );

                    console.log('âœ… Document updated');
                    closeEditDocModal();
                    loadDocuments();
                }
            } catch (error) {
                console.error('Error updating document:', error);
                alert('Failed to update document: ' + error.message);
            }
        }

        // ==================== CATEGORY MANAGEMENT ====================

        async function loadCustomCategories() {
            try {
                const snapshot = await window.firebaseGet(
                    window.firebaseDbRef(window.firebaseDatabase, 'customCategories')
                );

                if (snapshot.exists()) {
                    customCategories = Object.values(snapshot.val());
                } else {
                    customCategories = [];
                }
            } catch (error) {
                console.error('Error loading custom categories:', error);
                customCategories = [];
            }
        }

        async function saveCustomCategories() {
            try {
                const categoriesObj = {};
                customCategories.forEach((cat, index) => {
                    categoriesObj[index] = cat;
                });

                await window.firebaseSet(
                    window.firebaseDbRef(window.firebaseDatabase, 'customCategories'),
                    categoriesObj
                );
            } catch (error) {
                console.error('Error saving custom categories:', error);
            }
        }

        function populateCategoryDropdown(selectId) {
            const select = document.getElementById(selectId);
            const currentValue = select.value;

            select.innerHTML = '<option value="">Select Category</option>';

            // Add default categories
            defaultCategories.forEach(cat => {
                select.innerHTML += `<option value="${cat.value}">${cat.label}</option>`;
            });

            // Add custom categories
            customCategories.forEach(cat => {
                select.innerHTML += `<option value="${cat}">${cat}</option>`;
            });

            select.value = currentValue;
        }

        function openCategoryManager() {
            document.getElementById('categoryManagerModal').classList.add('active');
            displayCustomCategories();
        }

        function closeCategoryManager() {
            document.getElementById('categoryManagerModal').classList.remove('active');
            populateCategoryDropdown('docCategory');
        }

        function displayCustomCategories() {
            const container = document.getElementById('customCategoriesList');

            if (customCategories.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #999; font-size: 12px;">No custom categories yet</div>';
                return;
            }

            let html = '';
            customCategories.forEach((cat, index) => {
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f9fafb; border-radius: 6px; margin-bottom: 8px;">
                        <span style="font-weight: 600; color: #1a1a1a;">${cat}</span>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="editCustomCategory(${index})" style="padding: 4px 8px; background: #e0e7ff; color: #667eea; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600;">Edit</button>
                            <button onclick="deleteCustomCategory(${index}, '${cat}')" style="padding: 4px 8px; background: #fee2e2; color: #dc2626; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600;">Delete</button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        async function addCustomCategory() {
            const name = document.getElementById('newCategoryName').value.trim();

            if (!name) {
                alert('Please enter a category name');
                return;
            }

            // Check if already exists
            if (customCategories.includes(name) || defaultCategories.some(c => c.value === name)) {
                alert('This category already exists');
                return;
            }

            customCategories.push(name);
            await saveCustomCategories();
            document.getElementById('newCategoryName').value = '';
            displayCustomCategories();
            console.log('âœ… Category added:', name);
        }

        async function editCustomCategory(index) {
            const currentName = customCategories[index];
            const newName = prompt('Edit category name:', currentName);

            if (!newName || newName.trim() === '') return;

            const trimmedName = newName.trim();

            // Check if already exists
            if (trimmedName !== currentName && (customCategories.includes(trimmedName) || defaultCategories.some(c => c.value === trimmedName))) {
                alert('This category name already exists');
                return;
            }

            // Update documents using this category
            const docsToUpdate = allDocuments.filter(doc => doc.category === currentName);
            for (const doc of docsToUpdate) {
                doc.category = trimmedName;
                await window.firebaseSet(
                    window.firebaseDbRef(window.firebaseDatabase, 'documents/' + doc.id),
                    doc
                );
            }

            customCategories[index] = trimmedName;
            await saveCustomCategories();
            displayCustomCategories();
            loadDocuments();
            console.log('âœ… Category renamed:', currentName, 'â†’', trimmedName);
        }

        async function deleteCustomCategory(index, categoryName) {
            // Check if any documents use this category
            const docsUsingCategory = allDocuments.filter(doc => doc.category === categoryName);

            if (docsUsingCategory.length > 0) {
                alert(`Cannot delete category "${categoryName}" because ${docsUsingCategory.length} document(s) are using it. Please reassign those documents first.`);
                return;
            }

            if (!confirm(`Delete category "${categoryName}"?`)) return;

            customCategories.splice(index, 1);
            await saveCustomCategories();
            displayCustomCategories();
            console.log('âœ… Category deleted:', categoryName);
        }

        // ==================== DOCUMENT LIST MODAL ====================

        function showDocumentsByExpiration(status, title) {
            let filteredDocs = [];

            if (status === 'all') {
                filteredDocs = allDocuments;
            } else if (status === 'no-expiration') {
                filteredDocs = allDocuments.filter(doc => !doc.expirationDate);
            } else {
                filteredDocs = allDocuments.filter(doc => {
                    if (!doc.expirationDate) return false;
                    const label = getExpirationLabel(doc.expirationDate);
                    return label && label.status === status;
                });
            }

            displayDocumentListModal(filteredDocs, title);
        }

        function displayDocumentListModal(docs, title) {
            document.getElementById('documentListTitle').textContent = `${title} (${docs.length})`;
            const container = document.getElementById('documentListContent');

            if (docs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“‚</div>
                        <div style="font-size: 16px; font-weight: 600; color: #999; margin-bottom: 8px;">No Documents Found</div>
                    </div>
                `;
            } else {
                let html = '<div class="doc-list">';
                docs.forEach(doc => {
                    const expirationLabel = getExpirationLabel(doc.expirationDate);
                    const isExpired = expirationLabel && expirationLabel.status === 'expired';

                    html += `
                        <div class="doc-list-item" style="${isExpired ? 'background: #fef2f2;' : ''}">
                            <div style="text-align: center; font-size: 24px;">${getFileIcon(doc.fileType)}</div>
                            <div>
                                <div style="font-weight: 600; color: #1a1a1a; margin-bottom: 4px;">${doc.name}</div>
                                ${expirationLabel ? `
                                    <div style="display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; background: ${expirationLabel.bgColor}; color: ${expirationLabel.color};">
                                        ${expirationLabel.text}
                                    </div>
                                ` : ''}
                            </div>
                            <div class="doc-meta"><span>ğŸ‘¤ ${doc.person}</span></div>
                            <div class="doc-meta"><span>ğŸ·ï¸ ${doc.category}</span></div>
                            <div class="doc-meta"><span>ğŸ“¦ ${formatFileSize(doc.fileSize)}</span></div>
                            <div style="font-size: 12px;">
                                ${doc.expirationDate ? `
                                    <div style="font-weight: 600; color: ${expirationLabel ? expirationLabel.color : '#666'};">ğŸ“… ${new Date(doc.expirationDate).toLocaleDateString()}</div>
                                ` : `<span style="color: #999;">No expiry</span>`}
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="doc-btn view" onclick="viewDocument('${doc.id}', '${doc.fileName}')">ğŸ‘ï¸ View</button>
                                <button class="doc-btn" style="background: #e0e7ff; color: #667eea;" onclick="openEditDocModal('${doc.id}')">âœï¸</button>
                                <button class="doc-btn delete" onclick="deleteDocument('${doc.id}')">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            }

            document.getElementById('documentListModal').classList.add('active');
        }

        function closeDocumentListModal() {
            document.getElementById('documentListModal').classList.remove('active');
        }

        // ==================== TASK MANAGEMENT ====================

        function isOverdue(dueDate) {
            if (!dueDate) return false;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const due = new Date(dueDate);
            return due < today;
        }

        function loadDefaultTasks() {
            tasks = [
                { id: 1, category: 'ğŸ”´ CRITICAL - DO THIS FIRST', title: 'Verify I-94 validity for all family members', assigned: '', status: 'not-started', dueDate: '' },
                { id: 2, category: 'ğŸ”´ CRITICAL - DO THIS FIRST', title: 'Check USCIS SEVIS database and CBP I-94 records', assigned: '', status: 'not-started', dueDate: '' },
                { id: 3, category: 'ğŸ”´ CRITICAL - DO THIS FIRST', title: 'Apply for I-131 (Advance Parole) if I-94 expired', assigned: '', status: 'not-started', dueDate: '' },
                { id: 4, category: 'ğŸ”´ CRITICAL - DO THIS FIRST', title: 'Confirm H1B is valid and hasn\'t expired', assigned: '', status: 'not-started', dueDate: '' },
                { id: 5, category: 'ğŸ”´ CRITICAL - DO THIS FIRST', title: 'Confirm wife\'s and son\'s H4 validity', assigned: '', status: 'not-started', dueDate: '' },
                { id: 6, category: 'ğŸ”´ CRITICAL - DO THIS FIRST', title: 'Verify wife\'s EAD Card is valid', assigned: '', status: 'not-started', dueDate: '' },
                { id: 7, category: 'ğŸ”´ CRITICAL - DO THIS FIRST', title: 'Verify all passports are valid (6+ months)', assigned: '', status: 'not-started', dueDate: '' },
                { id: 8, category: 'ğŸ”´ CRITICAL - DO THIS FIRST', title: 'Get India visa for you, wife, and son', assigned: '', status: 'not-started', dueDate: '' },
                { id: 9, category: 'ğŸ”´ CRITICAL - DO THIS FIRST', title: 'Confirm daughter has US passport', assigned: '', status: 'not-started', dueDate: '' },
                { id: 10, category: 'ğŸ”´ CRITICAL - DO THIS FIRST', title: 'Clarify H1B extension or initial visa interview', assigned: '', status: 'not-started', dueDate: '' },
                { id: 11, category: 'ğŸ”´ CRITICAL - DO THIS FIRST', title: 'Gather employment documents (offer letter, pay stubs)', assigned: '', status: 'not-started', dueDate: '' },
                { id: 12, category: 'ğŸ”´ CRITICAL - DO THIS FIRST', title: 'Collect I-797 approval notices', assigned: '', status: 'not-started', dueDate: '' },
                { id: 13, category: 'ğŸ”´ CRITICAL - DO THIS FIRST', title: 'Confirm visa interview date, time, location', assigned: '', status: 'not-started', dueDate: '' },
                { id: 14, category: 'ğŸ”´ CRITICAL - DO THIS FIRST', title: 'Prepare interview answers and documents', assigned: '', status: 'not-started', dueDate: '' },
                { id: 15, category: 'ğŸ“„ DOCUMENTS TO PREPARE', title: 'Collect all passports (valid 6+ months)', assigned: '', status: 'not-started', dueDate: '' },
                { id: 16, category: 'ğŸ“„ DOCUMENTS TO PREPARE', title: 'Copy all stamped visa pages', assigned: '', status: 'not-started', dueDate: '' },
                { id: 17, category: 'ğŸ“„ DOCUMENTS TO PREPARE', title: 'Print I-94 records from CBP website', assigned: '', status: 'not-started', dueDate: '' },
                { id: 18, category: 'ğŸ“„ DOCUMENTS TO PREPARE', title: 'Collect I-797 forms (H1B and H4)', assigned: '', status: 'not-started', dueDate: '' },
                { id: 19, category: 'ğŸ“„ DOCUMENTS TO PREPARE', title: 'Carry wife\'s original EAD card', assigned: '', status: 'not-started', dueDate: '' },
                { id: 20, category: 'ğŸ“„ DOCUMENTS TO PREPARE', title: 'Collect birth certificates for all', assigned: '', status: 'not-started', dueDate: '' },
                { id: 21, category: 'ğŸ“„ DOCUMENTS TO PREPARE', title: 'Get certified copy of marriage certificate', assigned: '', status: 'not-started', dueDate: '' },
                { id: 22, category: 'ğŸ“„ DOCUMENTS TO PREPARE', title: 'Print flight tickets (6 copies)', assigned: '', status: 'not-started', dueDate: '' },
                { id: 23, category: 'ğŸ“„ DOCUMENTS TO PREPARE', title: 'Print hotel reservations', assigned: '', status: 'not-started', dueDate: '' },
                { id: 24, category: 'ğŸ“„ DOCUMENTS TO PREPARE', title: 'Print travel insurance policy', assigned: '', status: 'not-started', dueDate: '' },
                { id: 25, category: 'ğŸ“„ DOCUMENTS TO PREPARE', title: 'Collect medical records and vaccination records', assigned: '', status: 'not-started', dueDate: '' },
                { id: 26, category: 'ğŸ’³ FINANCIAL & BANKING', title: 'Inform banks about travel dates', assigned: '', status: 'not-started', dueDate: '' },
                { id: 27, category: 'ğŸ’³ FINANCIAL & BANKING', title: 'Get printed bank statements (3-6 months)', assigned: '', status: 'not-started', dueDate: '' },
                { id: 28, category: 'ğŸ’³ FINANCIAL & BANKING', title: 'Carry 2-3 credit cards (different companies)', assigned: '', status: 'not-started', dueDate: '' },
                { id: 29, category: 'ğŸ’³ FINANCIAL & BANKING', title: 'Exchange USD to INR', assigned: '', status: 'not-started', dueDate: '' },
                { id: 30, category: 'ğŸ’³ FINANCIAL & BANKING', title: 'Notify wife\'s employer about EAD travel', assigned: '', status: 'not-started', dueDate: '' },
                { id: 31, category: 'ğŸ‘” EMPLOYER & WORK', title: 'Notify your employer of travel dates', assigned: '', status: 'not-started', dueDate: '' },
                { id: 32, category: 'ğŸ‘” EMPLOYER & WORK', title: 'Confirm return ticket to resume work immediately', assigned: '', status: 'not-started', dueDate: '' },
                { id: 33, category: 'ğŸ‘” EMPLOYER & WORK', title: 'Get employer letter confirming employment', assigned: '', status: 'not-started', dueDate: '' },
                { id: 34, category: 'ğŸ‘” EMPLOYER & WORK', title: 'Wife: Notify your employer about travel', assigned: '', status: 'not-started', dueDate: '' },
                { id: 35, category: 'ğŸ‘” EMPLOYER & WORK', title: 'Wife: Get employment letter from company', assigned: '', status: 'not-started', dueDate: '' },
                { id: 36, category: 'ğŸ“š SCHOOL & FAMILY', title: 'Get official letter from school confirming grade', assigned: '', status: 'not-started', dueDate: '' },
                { id: 37, category: 'ğŸ“š SCHOOL & FAMILY', title: 'Collect homework/assignments for missed dates', assigned: '', status: 'not-started', dueDate: '' },
                { id: 38, category: 'ğŸ“š SCHOOL & FAMILY', title: 'Contact school about re-entry procedures', assigned: '', status: 'not-started', dueDate: '' },
                { id: 39, category: 'ğŸ“š SCHOOL & FAMILY', title: 'Get required immunization records', assigned: '', status: 'not-started', dueDate: '' },
                { id: 40, category: 'ğŸ  HOME PREPARATION', title: 'Arrange mail hold with USPS', assigned: '', status: 'not-started', dueDate: '' },
                { id: 41, category: 'ğŸ  HOME PREPARATION', title: 'Lock all windows and doors', assigned: '', status: 'not-started', dueDate: '' },
                { id: 42, category: 'ğŸ  HOME PREPARATION', title: 'Set thermostat appropriately', assigned: '', status: 'not-started', dueDate: '' },
                { id: 43, category: 'ğŸ  HOME PREPARATION', title: 'Ask neighbor to check on home', assigned: '', status: 'not-started', dueDate: '' },
                { id: 44, category: 'ğŸ  HOME PREPARATION', title: 'Take photos of valuable items for insurance', assigned: '', status: 'not-started', dueDate: '' },
                { id: 45, category: 'âš•ï¸ MEDICAL PREPARATIONS', title: 'Refill all prescriptions', assigned: '', status: 'not-started', dueDate: '' },
                { id: 46, category: 'âš•ï¸ MEDICAL PREPARATIONS', title: 'Visit dentist for checkup', assigned: '', status: 'not-started', dueDate: '' },
                { id: 47, category: 'âš•ï¸ MEDICAL PREPARATIONS', title: 'Visit doctor for checkup', assigned: '', status: 'not-started', dueDate: '' },
                { id: 48, category: 'âš•ï¸ MEDICAL PREPARATIONS', title: 'Get doctor\'s letter for medications', assigned: '', status: 'not-started', dueDate: '' },
                { id: 49, category: 'âš•ï¸ MEDICAL PREPARATIONS', title: 'Research hospitals near India destination', assigned: '', status: 'not-started', dueDate: '' },
                { id: 50, category: 'ğŸ‡®ğŸ‡³ INDIA PREPARATIONS', title: 'Book accommodations (hotel/family home)', assigned: '', status: 'not-started', dueDate: '' },
                { id: 51, category: 'ğŸ‡®ğŸ‡³ INDIA PREPARATIONS', title: 'Arrange transportation from airport', assigned: '', status: 'not-started', dueDate: '' },
                { id: 52, category: 'ğŸ‡®ğŸ‡³ INDIA PREPARATIONS', title: 'Confirm visa interview appointment details', assigned: '', status: 'not-started', dueDate: '' },
                { id: 53, category: 'ğŸ‡®ğŸ‡³ INDIA PREPARATIONS', title: 'Check weather forecast for India', assigned: '', status: 'not-started', dueDate: '' },
                { id: 54, category: 'ğŸ‡®ğŸ‡³ INDIA PREPARATIONS', title: 'Get Indian phone SIM or roaming plan', assigned: '', status: 'not-started', dueDate: '' },
                { id: 55, category: 'ğŸ‡®ğŸ‡³ INDIA PREPARATIONS', title: 'Notify family in India of arrival details', assigned: '', status: 'not-started', dueDate: '' },
                { id: 56, category: 'ğŸ‡®ğŸ‡³ INDIA PREPARATIONS', title: 'Purchase travel insurance', assigned: '', status: 'not-started', dueDate: '' },
                { id: 57, category: 'ğŸ‡®ğŸ‡³ INDIA PREPARATIONS', title: 'Print insurance policy and save digital copy', assigned: '', status: 'not-started', dueDate: '' },
                { id: 58, category: 'ğŸ‡®ğŸ‡³ INDIA PREPARATIONS', title: 'Convert USD to INR before departure', assigned: '', status: 'not-started', dueDate: '' },
                { id: 59, category: 'ğŸ‡®ğŸ‡³ INDIA PREPARATIONS', title: 'Research current exchange rates', assigned: '', status: 'not-started', dueDate: '' },
                { id: 60, category: 'ğŸ’ PACKING CHECKLIST', title: 'Pack copies of all important documents', assigned: '', status: 'not-started', dueDate: '' },
                { id: 61, category: 'ğŸ’ PACKING CHECKLIST', title: 'Pack passports (originals)', assigned: '', status: 'not-started', dueDate: '' },
                { id: 62, category: 'ğŸ’ PACKING CHECKLIST', title: 'Pack I-94 cards (originals)', assigned: '', status: 'not-started', dueDate: '' },
                { id: 63, category: 'ğŸ’ PACKING CHECKLIST', title: 'Pack medications (full supply)', assigned: '', status: 'not-started', dueDate: '' },
                { id: 64, category: 'ğŸ’ PACKING CHECKLIST', title: 'Pack phone chargers and power bank', assigned: '', status: 'not-started', dueDate: '' },
                { id: 65, category: 'ğŸ’ PACKING CHECKLIST', title: 'Pack credit cards and cash ($500)', assigned: '', status: 'not-started', dueDate: '' },
                { id: 66, category: 'ğŸ’ PACKING CHECKLIST', title: 'Pack winter/summer clothes for India', assigned: '', status: 'not-started', dueDate: '' },
                { id: 67, category: 'ğŸ’ PACKING CHECKLIST', title: 'Pack toiletries and first aid kit', assigned: '', status: 'not-started', dueDate: '' },
                { id: 68, category: 'ğŸ’ PACKING CHECKLIST', title: 'Pack formal wear for visa interview', assigned: '', status: 'not-started', dueDate: '' },
                { id: 69, category: 'ğŸ’ PACKING CHECKLIST', title: 'Pack son\'s study materials', assigned: '', status: 'not-started', dueDate: '' },
                { id: 70, category: 'ğŸ’ PACKING CHECKLIST', title: 'Pack universal adapter for India', assigned: '', status: 'not-started', dueDate: '' },
                { id: 71, category: 'âœ… FINAL PREPARATIONS', title: 'Reconfirm flight on Etihad website', assigned: '', status: 'not-started', dueDate: '' },
                { id: 72, category: 'âœ… FINAL PREPARATIONS', title: 'Register with US Embassy using STEP program', assigned: '', status: 'not-started', dueDate: '' },
                { id: 73, category: 'âœ… FINAL PREPARATIONS', title: 'Arrive airport 3 hours before departure', assigned: '', status: 'not-started', dueDate: '' },
                { id: 74, category: 'âœ… FINAL PREPARATIONS', title: 'Confirm Etihad return flight (Dec 15)', assigned: '', status: 'not-started', dueDate: '' },
                { id: 75, category: 'âœ… FINAL PREPARATIONS', title: 'Reconfirm return flight 24 hours before departure', assigned: '', status: 'not-started', dueDate: '' }
            ];
            nextId = 76;
        }

        function saveTasks() {
            if (!databaseURL) {
                console.log('Firebase URL not ready');
                return;
            }

            const validTasks = tasks.filter(t =>
                t && t.id && t.category && t.title && t.hasOwnProperty('assigned') && t.hasOwnProperty('status')
            );

            if (validTasks.length === 0) {
                console.log('No valid tasks to save');
                return;
            }

            const tasksObj = {};
            validTasks.forEach((task, index) => {
                tasksObj[index] = task;
            });

            console.log('Saving', validTasks.length, 'tasks to Firebase');

            fetch(databaseURL + '/tasks.json', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(tasksObj)
            })
            .then(r => {
                if (r.ok) console.log('âœ… Tasks saved to Firebase');
                else console.log('Save HTTP error:', r.status);
            })
            .catch(e => console.log('Save error:', e.message));
        }

        function displayDashboard() {
            const stats = {
                completed: tasks.filter(t => t.status === 'completed').length,
                'in-progress': tasks.filter(t => t.status === 'in-progress').length,
                waiting: tasks.filter(t => t.status === 'waiting').length,
                'not-started': tasks.filter(t => t.status === 'not-started').length,
                overdue: tasks.filter(t => isOverdue(t.dueDate) && t.status !== 'completed').length,
                siva: tasks.filter(t => t.assigned === 'Siva').length,
                priya: tasks.filter(t => t.assigned === 'Priya').length,
                both: tasks.filter(t => t.assigned === 'Both').length,
                'not-assigned': tasks.filter(t => !t.assigned || t.assigned === '').length,
                siva_completed: tasks.filter(t => t.assigned === 'Siva' && t.status === 'completed').length,
                priya_completed: tasks.filter(t => t.assigned === 'Priya' && t.status === 'completed').length,
                both_completed: tasks.filter(t => t.assigned === 'Both' && t.status === 'completed').length,
                'not-assigned_completed': tasks.filter(t => (!t.assigned || t.assigned === '') && t.status === 'completed').length
            };

            document.getElementById('stat-completed').textContent = stats.completed;
            document.getElementById('stat-completed').parentElement.onclick = () => showTasksByStatus('completed', 'âœ… Completed Tasks');

            document.getElementById('stat-in-progress').textContent = stats['in-progress'];
            document.getElementById('stat-in-progress').parentElement.onclick = () => showTasksByStatus('in-progress', 'ğŸ”„ In Progress Tasks');

            document.getElementById('stat-waiting').textContent = stats.waiting;
            document.getElementById('stat-waiting').parentElement.onclick = () => showTasksByStatus('waiting', 'â³ Waiting Tasks');

            document.getElementById('stat-not-started').textContent = stats['not-started'];
            document.getElementById('stat-not-started').parentElement.onclick = () => showTasksByStatus('not-started', 'ğŸ“‹ Not Started Tasks');

            document.getElementById('stat-overdue').textContent = stats.overdue;
            document.getElementById('stat-overdue').parentElement.onclick = () => showTasksByStatus('overdue', 'âš ï¸ Overdue Tasks');

            document.getElementById('stat-total').textContent = tasks.length;
            document.getElementById('stat-total').parentElement.onclick = () => showTasksByStatus('all', 'ğŸ“ All Tasks');

            document.getElementById('stat-siva-progress').textContent = `${stats.siva_completed}/${stats.siva}`;
            document.getElementById('stat-siva-progress').parentElement.onclick = () => showTasksByAssignee('Siva', 'ğŸ‘¨ Siva\'s Tasks');

            document.getElementById('stat-priya-progress').textContent = `${stats.priya_completed}/${stats.priya}`;
            document.getElementById('stat-priya-progress').parentElement.onclick = () => showTasksByAssignee('Priya', 'ğŸ‘© Priya\'s Tasks');

            document.getElementById('stat-both-progress').textContent = `${stats.both_completed}/${stats.both}`;
            document.getElementById('stat-both-progress').parentElement.onclick = () => showTasksByAssignee('Both', 'ğŸ‘¥ Shared Tasks');

            document.getElementById('stat-not-assigned-progress').textContent = `${stats['not-assigned_completed']}/${stats['not-assigned']}`;
            document.getElementById('stat-not-assigned-progress').parentElement.onclick = () => showTasksByAssignee('', 'â“ Not Assigned Tasks');
        }

        function displayTasks() {
            console.log('displayTasks called. Total tasks:', tasks.length);

            if (isUserTyping) {
                console.log('User typing - skipping re-render');
                return;
            }

            Object.keys(categoryMap).forEach(tab => {
                const categoryName = categoryMap[tab];
                const container = document.getElementById(tab);

                if (!container) {
                    console.error('Container not found for tab:', tab);
                    return;
                }

                const categoryTasks = tasks.filter(t => t.category === categoryName);
                console.log(`Category ${categoryName}: ${categoryTasks.length} tasks`);

                const inputId = 'newTask_' + tab;
                const dateId = 'newDate_' + tab;
                const existingInput = document.getElementById(inputId);
                const existingDate = document.getElementById(dateId);
                const savedInputValue = existingInput ? existingInput.value : '';
                const savedDateValue = existingDate ? existingDate.value : '';

                let html = `
                    <div class="add-task-form">
                        <div style="font-weight: 600; margin-bottom: 10px; color: #666;">â• Add New Task</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Title</label>
                                <input type="text" id="newTask_${tab}" placeholder="Task name..." value="${savedInputValue}" onkeyup="markUserTyping()" onkeydown="markUserTyping()" onchange="unmarkUserTyping()" />
                            </div>
                            <div class="form-group">
                                <label>Due Date</label>
                                <input type="date" id="newDate_${tab}" value="${savedDateValue}" onkeyup="markUserTyping()" onkeydown="markUserTyping()" onchange="unmarkUserTyping()" />
                            </div>
                            <button class="btn-add" onclick="addTask('${tab}', '${categoryName}')">Add</button>
                        </div>
                    </div>
                    <div class="category-header">${categoryName}</div>
                `;

                if (categoryTasks.length === 0) {
                    html += '<div style="text-align: center; padding: 30px; color: #999;">No tasks in this category</div>';
                } else {
                    categoryTasks.forEach(task => {
                        const isOverdueTask = isOverdue(task.dueDate) && task.status !== 'completed';
                        const assignedBadge = task.assigned
                            ? `<span class="task-badge ${task.assigned.toLowerCase()}">${task.assigned === 'Siva' ? 'ğŸ‘¨' : task.assigned === 'Priya' ? 'ğŸ‘©' : 'ğŸ‘¥'} ${task.assigned}</span>`
                            : '<span class="task-badge not-assigned">â“ Not Assigned</span>';

                        html += `
                            <div class="task-item ${task.status === 'completed' ? 'completed' : ''} ${isOverdueTask ? 'overdue' : ''}">
                                <div class="task-header">
                                    <div class="task-title">${task.title}</div>
                                    ${assignedBadge}
                                </div>
                                ${task.dueDate ? `<div class="task-meta ${isOverdueTask ? 'overdue' : ''}">ğŸ“… ${new Date(task.dueDate).toLocaleDateString()} ${isOverdueTask ? 'âš ï¸ OVERDUE' : ''}</div>` : ''}
                                <div class="task-controls">
                                    <select onchange="updateStatus(${task.id}, this.value)">
                                        <option value="not-started" ${task.status === 'not-started' ? 'selected' : ''}>Not Started</option>
                                        <option value="in-progress" ${task.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                                        <option value="waiting" ${task.status === 'waiting' ? 'selected' : ''}>Waiting</option>
                                        <option value="completed" ${task.status === 'completed' ? 'selected' : ''}>Completed</option>
                                    </select>
                                    <input type="date" value="${task.dueDate || ''}" onchange="updateDate(${task.id}, this.value)">
                                    <select onchange="updateAssigned(${task.id}, this.value)">
                                        <option value="">â“ Not Assigned</option>
                                        <option value="Siva" ${task.assigned === 'Siva' ? 'selected' : ''}>ğŸ‘¨ Siva</option>
                                        <option value="Priya" ${task.assigned === 'Priya' ? 'selected' : ''}>ğŸ‘© Priya</option>
                                        <option value="Both" ${task.assigned === 'Both' ? 'selected' : ''}>ğŸ‘¥ Both</option>
                                    </select>
                                    <button class="btn-edit" onclick="openEditModal(${task.id}, '${task.title.replace(/'/g, "\\'")}')">âœï¸ Edit</button>
                                    <button class="btn-delete" onclick="deleteTask(${task.id})" title="Delete">ğŸ—‘ï¸</button>
                                </div>
                            </div>
                        `;
                    });
                }

                container.innerHTML = html;
            });

            displayDashboard();
        }

        function markUserTyping() {
            isUserTyping = true;
        }

        function unmarkUserTyping() {
            isUserTyping = false;
            setTimeout(() => {
                if (!isUserTyping) {
                    displayTasks();
                }
            }, 500);
        }

        function addTask(tab, categoryName) {
            isUserTyping = false;
            const title = document.getElementById(`newTask_${tab}`).value.trim();
            const dueDate = document.getElementById(`newDate_${tab}`).value;

            if (!title) {
                alert('Please enter a task title');
                return;
            }

            tasks.push({
                id: nextId++,
                category: categoryName,
                title,
                assigned: '',
                status: 'not-started',
                dueDate
            });

            saveTasks();
            displayTasks();

            setTimeout(() => {
                const newInput = document.getElementById(`newTask_${tab}`);
                const newDate = document.getElementById(`newDate_${tab}`);
                if (newInput) {
                    newInput.value = '';
                    newInput.focus();
                }
                if (newDate) {
                    newDate.value = '';
                }
            }, 100);
        }

        function updateStatus(id, status) {
            const task = tasks.find(t => t.id === id);
            if (task) {
                task.status = status;
                saveTasks();
                displayDashboard();
            }
        }

        function updateDate(id, date) {
            const task = tasks.find(t => t.id === id);
            if (task) {
                task.dueDate = date;
                saveTasks();
                displayDashboard();
            }
        }

        function updateAssigned(id, assigned) {
            const task = tasks.find(t => t.id === id);
            if (task) {
                task.assigned = assigned;
                saveTasks();
                displayDashboard();
            }
        }

        function deleteTask(id) {
            if (confirm('Delete this task?')) {
                tasks = tasks.filter(t => t.id !== id);
                saveTasks();
                displayTasks();
            }
        }

        let editingTaskId = null;

        function openEditModal(taskId, taskTitle) {
            editingTaskId = taskId;
            document.getElementById('editTaskTitle').value = taskTitle;
            document.getElementById('editModal').classList.add('active');
            document.getElementById('editTaskTitle').focus();
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            editingTaskId = null;
        }

        function saveTaskEdit() {
            if (!editingTaskId) return;

            const newTitle = document.getElementById('editTaskTitle').value.trim();
            if (!newTitle) {
                alert('Please enter a task description');
                return;
            }

            const task = tasks.find(t => t.id === editingTaskId);
            if (task) {
                task.title = newTitle;
                saveTasks();
                displayTasks();
                closeEditModal();
                console.log('âœ… Task updated:', newTitle);
            }
        }

        function showTasksByStatus(status, title) {
            let filteredTasks = [];

            if (status === 'overdue') {
                filteredTasks = tasks.filter(t => isOverdue(t.dueDate) && t.status !== 'completed');
            } else if (status === 'all') {
                filteredTasks = tasks;
            } else {
                filteredTasks = tasks.filter(t => t.status === status);
            }

            displayTaskListModal(filteredTasks, title);
        }

        function showTasksByAssignee(assignee, title) {
            let filteredTasks = [];

            if (assignee === '') {
                filteredTasks = tasks.filter(t => !t.assigned || t.assigned === '');
            } else {
                filteredTasks = tasks.filter(t => t.assigned === assignee);
            }

            displayTaskListModal(filteredTasks, title);
        }

        function displayTaskListModal(filteredTasks, title) {
            const titleEl = document.getElementById('taskListTitle');
            const contentEl = document.getElementById('taskListContent');

            titleEl.textContent = title + ' (' + filteredTasks.length + ')';

            if (filteredTasks.length === 0) {
                contentEl.innerHTML = '<div style="text-align: center; padding: 30px; color: #999;">No tasks found</div>';
            } else {
                let html = '';
                filteredTasks.forEach(task => {
                    const isOverdueTask = isOverdue(task.dueDate) && task.status !== 'completed';
                    const statusClass = isOverdueTask ? 'overdue' : task.status;
                    const assignedBadge = task.assigned ? task.assigned : 'Not Assigned';

                    const statusLabel = task.status === 'not-started' ? 'Not Started'
                                      : task.status === 'in-progress' ? 'In Progress'
                                      : task.status === 'waiting' ? 'Waiting'
                                      : 'Completed';

                    html += `
                        <div class="task-list-item ${statusClass}">
                            <div class="task-list-title">${task.title}</div>
                            <div class="task-list-meta">
                                <span>ğŸ“Œ ${task.category}</span>
                                <span>ğŸ‘¤ ${assignedBadge}</span>
                                <span>ğŸ“Š ${statusLabel}</span>
                                ${task.dueDate ? `<span>ğŸ“… ${new Date(task.dueDate).toLocaleDateString()}</span>` : ''}
                            </div>
                        </div>
                    `;
                });
                contentEl.innerHTML = html;
            }

            document.getElementById('taskListModal').classList.add('active');
        }

        function closeTaskListModal() {
            document.getElementById('taskListModal').classList.remove('active');
        }

        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function openResetConfirm() {
            document.getElementById('resetConfirmModal').classList.add('active');
            document.getElementById('resetConfirmInput').value = '';
            document.getElementById('resetConfirmBtn').disabled = true;
            document.getElementById('resetConfirmBtn').style.opacity = '0.5';
            document.getElementById('resetConfirmBtn').style.cursor = 'not-allowed';
            document.getElementById('resetConfirmInput').focus();
        }

        function closeResetConfirm() {
            document.getElementById('resetConfirmModal').classList.remove('active');
            document.getElementById('resetConfirmInput').value = '';
        }

        document.addEventListener('input', function(e) {
            if (e.target.id === 'resetConfirmInput') {
                const value = e.target.value.trim().toUpperCase();
                const btn = document.getElementById('resetConfirmBtn');

                if (value === 'RESET') {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                } else {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                }
            }
        });

        function confirmReset() {
            const value = document.getElementById('resetConfirmInput').value.trim().toUpperCase();

            if (value !== 'RESET') {
                alert('Please type "RESET" to confirm');
                return;
            }

            clearFirebase();
            closeResetConfirm();
            closeSettings();
        }

        function clearFirebase() {
            if (confirm('ğŸ”„ Last chance! This will DELETE all Firebase data and rebuild with default tasks. Are you absolutely sure?')) {
                fetch(databaseURL + '/tasks.json', {
                    method: 'DELETE'
                }).then(() => {
                    console.log('âœ… Firebase cleared');
                    loadDefaultTasks();
                    saveTasks();
                    displayTasks();
                    alert('âœ… Firebase cleared and rebuilt with fresh data!');
                    location.reload();
                }).catch(e => {
                    console.log('Error clearing Firebase:', e);
                    alert('Could not clear Firebase. Try manually via Firebase Console.');
                });
            }
        }

        function switchView(tab) {
            console.log('Switching to tab:', tab);

            document.querySelectorAll('.tab-view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

            const view = document.getElementById(tab);
            if (view) {
                view.classList.add('active');
            }

            if (event && event.target) {
                event.target.classList.add('active');
            }

            if (tab === 'doc-manager') {
                loadDocuments();
            } else {
                console.log('Refreshing task display...');
                displayTasks();
            }
        }

        window.addEventListener('load', () => {
            console.log('Page loading...');

            loadDefaultTasks();
            console.log('Default tasks loaded:', tasks.length);

            displayTasks();
            console.log('Tasks displayed');

            databaseURL = databaseURL.replace(/\/tasks\.json$/, '');
            console.log('Firebase URL ready:', databaseURL);

            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeEditModal();
                    closeTaskListModal();
                    closeSettings();
                    closeResetConfirm();
                    closeUploadModal();
                    closeDocViewer();
                    closeEditDocModal();
                    closeCategoryManager();
                    closeDocumentListModal();
                }
            });

            document.addEventListener('click', function(e) {
                const editModal = document.getElementById('editModal');
                const taskListModal = document.getElementById('taskListModal');
                const settingsModal = document.getElementById('settingsModal');
                const resetConfirmModal = document.getElementById('resetConfirmModal');
                const uploadModal = document.getElementById('uploadModal');
                const docViewerModal = document.getElementById('docViewerModal');
                const editDocModal = document.getElementById('editDocModal');
                const categoryManagerModal = document.getElementById('categoryManagerModal');
                const documentListModal = document.getElementById('documentListModal');

                if (e.target === editModal) closeEditModal();
                if (e.target === taskListModal) closeTaskListModal();
                if (e.target === settingsModal) closeSettings();
                if (e.target === resetConfirmModal) closeResetConfirm();
                if (e.target === uploadModal) closeUploadModal();
                if (e.target === docViewerModal) closeDocViewer();
                if (e.target === editDocModal) closeEditDocModal();
                if (e.target === categoryManagerModal) closeCategoryManager();
                if (e.target === documentListModal) closeDocumentListModal();
            });

            // Load custom categories
            loadCustomCategories();

            fetch(databaseURL + '/tasks.json')
                .then(r => r.json())
                .then(data => {
                    if (data && typeof data === 'object' && Object.keys(data).length > 0) {
                        const firebaseTasks = Object.values(data).filter(t => t && typeof t === 'object');
                        const isNewFormat = firebaseTasks.some(t => t.hasOwnProperty('assigned'));

                        if (firebaseTasks.length > 0 && isNewFormat) {
                            console.log('âœ… Firebase has new format. Loading:', firebaseTasks.length, 'tasks');
                            tasks = firebaseTasks;
                            nextId = Math.max(...tasks.map(t => t.id || 0)) + 1;
                            displayTasks();
                        } else {
                            console.log('âš ï¸ Firebase has OLD format. Using local defaults instead.');
                        }
                    }
                })
                .catch(e => console.log('Firebase not available - using local defaults'));

            setInterval(() => {
                if (databaseURL && !isUserTyping) {
                    fetch(databaseURL + '/tasks.json')
                        .then(r => r.json())
                        .then(data => {
                            if (data && typeof data === 'object' && Object.keys(data).length > 0) {
                                const firebaseTasks = Object.values(data).filter(t => t && typeof t === 'object');
                                const isNewFormat = firebaseTasks.some(t => t.hasOwnProperty('assigned'));

                                if (firebaseTasks.length > 0 && isNewFormat && !isUserTyping) {
                                    tasks = firebaseTasks;
                                    nextId = Math.max(...tasks.map(t => t.id || 0)) + 1;
                                    displayTasks();
                                }
                            }
                        })
                        .catch(e => null);
                }
            }, 10000);
        });
    </script>
</body>
</html>
